<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
   <head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script>
      <title>C++ API Reference: simplePhysicsEngine/simplePhysicsEngine.cpp</title>
      
	  
      
      
      
      
      
      
      
    

</head>
   <body height="100%"><div class="body_content" id="body-content"><link rel="stylesheet" type="text/css" href="cpp_ref/navtree.css"><link rel="stylesheet" type="text/css" href="cpp_ref/doxygen.css"><link rel="stylesheet" type="text/css" href="cpp_ref/tabs.css"><link rel="stylesheet" type="text/css" href="style/adsk.cpm.css"><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('simple_physics_engine_2simple_physics_engine_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script>
      <div>
         <div class="head">
            <h1>C++ API Reference: simplePhysicsEngine/simplePhysicsEngine.cpp</h1>
         </div>

<div id="top"><!-- do not remove this div, it is closed by doxygen! -->

<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->

  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="#!/url=./cpp_ref/index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="#!/url=./cpp_ref/pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="#!/url=./cpp_ref/modules.html"><span>Modules</span></a></li>
      <li><a href="#!/url=./cpp_ref/namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="#!/url=./cpp_ref/annotated.html"><span>Classes</span></a></li>
      <li><a href="#!/url=./cpp_ref/examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="cpp_ref/search/mag_sel.png" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()" alt="">
          <input type="text" id="MSearchField" value="Search" accesskey="S" onfocus="searchBox.OnSearchFieldFocus(true)" onblur="searchBox.OnSearchFieldFocus(false)" onkeyup="searchBox.OnSearchFieldChange(event)">
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="cpp_ref/search/close.png" alt=""></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" class="ui-resizable-handle">
  </div>
</div>

<div id="doc-content">
<!-- window showing the filter options -->


<!-- iframe showing the search results (closed by default) -->


<div class="header">
  <div class="headertitle">
<div class="title">simplePhysicsEngine/simplePhysicsEngine.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">// Copyright 2019 Autodesk, Inc.  All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk</span></div>
<div class="line"><span class="comment">// license agreement provided at the time of installation or download,</span></div>
<div class="line"><span class="comment">// or which otherwise accompanies this software in either electronic</span></div>
<div class="line"><span class="comment">// or hard copy form.</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// This plug-in demonstrates how to implement a simple simulation system with full support for Cached Playback.</span></div>
<div class="line"><span class="comment">//   - Using MPxNode::getCacheSetup() to trigger the &#39;Dynamics Cache Layer&#39; behavior</span></div>
<div class="line"><span class="comment">//   - Using MPxNode::configCache() to setup attributes to cache</span></div>
<div class="line"><span class="comment">//   - Using MPxNode::transformInvalidationRange() to setup the correct invalidation range for dynamics system</span></div>
<div class="line"><span class="comment">//   - The correct way to readback cached dynamics status and support &#39;Simulation resumption from arbitrary time&#39;</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// To run this example, execute the MEL code below.</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">```MEL</span></div>
<div class="line"><span class="comment">file -new -force;</span></div>
<div class="line"><span class="comment">loadPlugin simplePhysicsEngine;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">createNode physicsEngine -name &quot;solver&quot;;</span></div>
<div class="line"><span class="comment">polySphere -r 1 -name &quot;sphere&quot; -constructionHistory 1;</span></div>
<div class="line"><span class="comment">connectAttr solver.position sphere.translate;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Create a plane for collision, and start to tilt it</span></div>
<div class="line"><span class="comment">polyPlane -w 50 -h 50 -sx 1 -sy 1 -name &quot;ground&quot;;</span></div>
<div class="line"><span class="comment">setKeyframe -v 0 -t 1 &quot;ground.rz&quot;;</span></div>
<div class="line"><span class="comment">setKeyframe -v -20 -t 120 &quot;ground.rz&quot;;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Convert the transform of this plane into the Ax+By+Cz+D=0 form that solver node accepts</span></div>
<div class="line"><span class="comment">createNode -parent &quot;ground&quot; -name &quot;o&quot; locator;</span></div>
<div class="line"><span class="comment">createNode -parent &quot;ground&quot; -name &quot;y&quot; locator;</span></div>
<div class="line"><span class="comment">setAttr &quot;y.localPositionY&quot; 1;</span></div>
<div class="line"><span class="comment">setAttr &quot;o.visibility&quot; 0;</span></div>
<div class="line"><span class="comment">setAttr &quot;y.visibility&quot; 0;</span></div>
<div class="line"><span class="comment">// ground.normal = (0,1,0,0) * matrix</span></div>
<div class="line"><span class="comment">createNode plusMinusAverage -n &quot;normal&quot;;</span></div>
<div class="line"><span class="comment">setAttr &quot;normal.operation&quot; 2; // subtract</span></div>
<div class="line"><span class="comment">connectAttr y.worldPosition[0] normal.input3D[0];</span></div>
<div class="line"><span class="comment">connectAttr o.worldPosition[0] normal.input3D[1];</span></div>
<div class="line"><span class="comment">connectAttr -force normal.output3Dx solver.collisionPlane0;</span></div>
<div class="line"><span class="comment">connectAttr -force normal.output3Dy solver.collisionPlane1;</span></div>
<div class="line"><span class="comment">connectAttr -force normal.output3Dz solver.collisionPlane2;</span></div>
<div class="line"><span class="comment">// ground.offset = -dot((0,0,0,1) * matrix, ground.normal) - sphere.radius</span></div>
<div class="line"><span class="comment">createNode multiplyDivide -n &quot;offset_mul&quot;;</span></div>
<div class="line"><span class="comment">setAttr &quot;offset_mul.operation&quot; 1; // multiply</span></div>
<div class="line"><span class="comment">connectAttr o.worldPosition[0] offset_mul.input1;</span></div>
<div class="line"><span class="comment">connectAttr normal.output3D    offset_mul.input2;</span></div>
<div class="line"><span class="comment">createNode plusMinusAverage -n &quot;offset&quot;;</span></div>
<div class="line"><span class="comment">setAttr &quot;offset.operation&quot; 2; // subtract</span></div>
<div class="line"><span class="comment">setAttr &quot;offset.input1D[0]&quot; 0;</span></div>
<div class="line"><span class="comment">connectAttr offset_mul.outputX offset.input1D[1];</span></div>
<div class="line"><span class="comment">connectAttr offset_mul.outputY offset.input1D[2];</span></div>
<div class="line"><span class="comment">connectAttr offset_mul.outputZ offset.input1D[3];</span></div>
<div class="line"><span class="comment">connectAttr polySphere1.r offset.input1D[4];</span></div>
<div class="line"><span class="comment">connectAttr offset.output1D solver.collisionPlane3;</span></div>
<div class="line"><span class="comment">```</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;type_traits&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;utility&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPxNode.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnNumericAttribute.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnUnitAttribute.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnCompoundAttribute.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MString.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MTypeId.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPlug.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDataBlock.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDataHandle.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnPlugin.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MNodeCacheDisablingInfoHelper.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDGMessage.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MItDependencyNodes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFn.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDGModifier.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Helpers for vector math</span></div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line"><span class="keyword">struct </span>MDouble3 { <span class="keywordtype">double</span> x, y, z; };</div>
<div class="line"><span class="keyword">struct </span>MDouble4 { <span class="keywordtype">double</span> x, y, z, w; };</div>
<div class="line">MDouble3 operator+ (MDouble3 lhs, MDouble3 rhs) noexcept { <span class="keywordflow">return</span> { lhs.x + rhs.x, lhs.y + rhs.y, lhs.z + rhs.z }; }</div>
<div class="line">MDouble3 operator- (MDouble3 lhs, MDouble3 rhs) noexcept { <span class="keywordflow">return</span> { lhs.x - rhs.x, lhs.y - rhs.y, lhs.z - rhs.z }; }</div>
<div class="line">MDouble3 operator* (MDouble3 lhs, MDouble3 rhs) noexcept { <span class="keywordflow">return</span> { lhs.x * rhs.x, lhs.y * rhs.y, lhs.z * rhs.z }; }</div>
<div class="line">MDouble3 operator* (MDouble3 lhs, <span class="keywordtype">double</span> rhs)   noexcept { <span class="keywordflow">return</span> { lhs.x * rhs, lhs.y * rhs, lhs.z * rhs }; }</div>
<div class="line">MDouble3 operator/ (MDouble3 lhs, MDouble3 rhs) noexcept { <span class="keywordflow">return</span> { lhs.x / rhs.x, lhs.y / rhs.y, lhs.z / rhs.z }; }</div>
<div class="line">MDouble3 operator/ (MDouble3 lhs, <span class="keywordtype">double</span> rhs)   noexcept { <span class="keywordflow">return</span> { lhs.x / rhs, lhs.y / rhs, lhs.z / rhs }; }</div>
<div class="line"></div>
<div class="line">MDouble4 to4(MDouble3 v, <span class="keywordtype">double</span> w) { <span class="keywordflow">return</span> { v.x,v.y,v.z,w }; }</div>
<div class="line">MDouble3 xyz(MDouble4 v) { <span class="keywordflow">return</span> { v.x,v.y,v.z }; }</div>
<div class="line"><span class="keywordtype">double</span>   dot(MDouble4 lhs, MDouble4 rhs) noexcept { <span class="keywordflow">return</span> lhs.x * rhs.x + lhs.y * rhs.y + lhs.z * rhs.z + lhs.w * rhs.w; }</div>
<div class="line"><span class="keywordtype">double</span>   dot(MDouble3 lhs, MDouble3 rhs) noexcept { <span class="keywordflow">return</span> lhs.x * rhs.x + lhs.y * rhs.y + lhs.z * rhs.z; }</div>
<div class="line">MDouble3 normalized(MDouble3 v) { <span class="keywordflow">return</span> v / sqrt(dot(v,v)); }</div>
<div class="line">MDouble3 point_on_plane(MDouble4 p) {</div>
<div class="line">    <span class="keywordflow">if</span> (p.x != .0) {</div>
<div class="line">        <span class="keywordflow">return</span> { -p.w / p.x, .0, .0 };</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p.y != .0) {</div>
<div class="line">        <span class="keywordflow">return</span> { .0, -p.w / p.y, .0 };</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p.z != .0) {</div>
<div class="line">        <span class="keywordflow">return</span> { .0, .0, -p.w / p.z };</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> { .0,.0,.0 };</div>
<div class="line">};</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// helpers for Maya attributes access</span></div>
<div class="line"><span class="keyword">namespace</span>{</div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">struct </span>MAttributeOf : <a name="_a0"></a><a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a> {</div>
<div class="line">    <span class="keyword">using</span> type = T;</div>
<div class="line">    <span class="keyword">using</span> <a name="a1"></a><a class="code" href="#!/url=./cpp_ref/class_m_object.html#a9cb12a9afeb4550003be304968774f46">MObject::MObject</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</div>
<div class="line">    MAttributeOf&amp; <a name="a2"></a><a class="code" href="#!/url=./cpp_ref/class_m_object.html#aaca8de7e494d322ba6ac29654010ed5a">operator=</a>(U&amp;&amp; arg) { <a class="code" href="#!/url=./cpp_ref/class_m_object.html#aaca8de7e494d322ba6ac29654010ed5a">MObject::operator=</a>(std::forward&lt;U&gt;(arg)); <span class="keywordflow">return</span> *<span class="keyword">this</span>; }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>detail {</div>
<div class="line">    <span class="keyword">struct </span>error_type {}; <span class="comment">// Placeholder type to detect usage of as&lt;T&gt; with not specialization </span></div>
<div class="line"></div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">    decltype(<span class="keyword">auto</span>) as(const <a name="_a3"></a><a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a>&amp; handle) { <span class="keywordflow">return</span> error_type{}; }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">template</span> &lt;&gt; decltype(<span class="keyword">auto</span>) as&lt;<span class="keywordtype">bool</span>&gt;(const <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a>&amp; handle) { <span class="keywordflow">return</span> handle.asBool(); }</div>
<div class="line">    <span class="keyword">template</span> &lt;&gt; decltype(<span class="keyword">auto</span>) as&lt;<span class="keywordtype">double</span>&gt;(const <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a>&amp; handle) { <span class="keywordflow">return</span> handle.asDouble(); }</div>
<div class="line">    <span class="keyword">template</span> &lt;&gt; decltype(<span class="keyword">auto</span>) as&lt;<a name="_a4"></a><a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a>&gt;(const <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a>&amp; handle) { <span class="keywordflow">return</span> handle.asTime(); }</div>
<div class="line">    <span class="keyword">template</span> &lt;&gt;</div>
<div class="line">    decltype(<span class="keyword">auto</span>) as&lt;MDouble3&gt;(const <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a>&amp; handle) {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span>MDouble3&amp;<span class="keyword">&gt;</span>(handle.asDouble3());</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">template</span> &lt;&gt;</div>
<div class="line">    decltype(<span class="keyword">auto</span>) as&lt;MDouble4&gt;(const <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a>&amp; handle) {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span>MDouble4&amp;<span class="keyword">&gt;</span>(handle.asDouble4());</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Add more specializations for all the asXXX methods</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">decltype(<span class="keyword">auto</span>) get_input(<a name="_a5"></a><a class="code" href="#!/url=./cpp_ref/class_m_data_block.html">MDataBlock</a>&amp; data, const MAttributeOf&lt;T&gt;&amp; attr) {</div>
<div class="line">    <a name="_a6"></a><a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> status;</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a> handle = data.inputValue(static_cast&lt;const MObject&amp;&gt;(attr), &amp;status);</div>
<div class="line">    assert(status == <a name="a7"></a><a class="code" href="#!/url=./cpp_ref/class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>);</div>
<div class="line">    return ::detail::as&lt;T&gt;(handle);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">decltype(<span class="keyword">auto</span>) get_as_is(<a class="code" href="#!/url=./cpp_ref/class_m_data_block.html">MDataBlock</a>&amp; data, const MAttributeOf&lt;T&gt;&amp; attr) {</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> status;</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a> handle = data.outputValue(static_cast&lt;const MObject&amp;&gt;(attr), &amp;status);</div>
<div class="line">    assert(status == <a class="code" href="#!/url=./cpp_ref/class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>);</div>
<div class="line">    return ::detail::as&lt;T&gt;(handle);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> set(<a class="code" href="#!/url=./cpp_ref/class_m_data_block.html">MDataBlock</a>&amp; data, <span class="keyword">const</span> MAttributeOf&lt;T&gt;&amp; attr, <span class="keyword">const</span> T&amp; value) {</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> status;</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html">MDataHandle</a> handle = data.<a name="a8"></a><a class="code" href="#!/url=./cpp_ref/class_m_data_block.html#a5e4082d6ab961bee4ec0281676bb4834">outputValue</a>(static_cast&lt;const MObject&amp;&gt;(attr), &amp;status);</div>
<div class="line">    assert(status == <a class="code" href="#!/url=./cpp_ref/class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>);</div>
<div class="line">    ::detail::as&lt;T&gt;(handle) = value; <span class="comment">// MDataHandle.set(...) cannot handle 4 double...</span></div>
<div class="line">    handle.<a name="a9"></a><a class="code" href="#!/url=./cpp_ref/class_m_data_handle.html#a7bdd61b8405188bb547fdba3fddace91">setClean</a>();</div>
<div class="line">}</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Helpers for physics simulation</span></div>
<div class="line"><span class="keyword">namespace </span>physics {</div>
<div class="line">    <span class="keyword">struct </span>ObjectStatus {</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a>    Time;</div>
<div class="line">        MDouble3 Position;</div>
<div class="line">        MDouble3 Velocity;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    ObjectStatus apply_velocity(<span class="keyword">const</span> ObjectStatus&amp; prev, <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> dt, MDouble3 acceleration) {</div>
<div class="line">        <span class="keywordtype">double</span> dts = dt.<a name="a10"></a><a class="code" href="#!/url=./cpp_ref/class_m_time.html#a105d41236561f4d4be6383ced757a429">as</a>(<a name="a11"></a><a class="code" href="#!/url=./cpp_ref/class_m_time.html#abceb2331ad056e3c5ad27894199a49eda3091d1a096c28d4993507f167253ebc7">MTime::kSeconds</a>);</div>
<div class="line">        ObjectStatus now;</div>
<div class="line">        now.Time = prev.Time + dt;</div>
<div class="line">        now.Velocity = prev.Velocity + acceleration * dts;</div>
<div class="line">        now.Position = prev.Position + (now.Velocity + prev.Velocity) * (0.5 * dts);</div>
<div class="line">        <span class="keywordflow">return</span> now;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ObjectStatus resolve_collision(ObjectStatus particle, MDouble4 ground, <span class="keywordtype">double</span> elasticity) {</div>
<div class="line">        assert(elasticity &gt;= 0);</div>
<div class="line">        MDouble4 p = to4(particle.Position, 1.0);</div>
<div class="line">        <span class="keywordtype">double</span>   v = dot(p, ground);</div>
<div class="line">        <span class="keywordflow">if</span> (v &gt; .0) {</div>
<div class="line">            <span class="comment">// no collision</span></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">// The the object have collide with the ground plane</span></div>
<div class="line">            MDouble3 gp = point_on_plane(ground); <span class="comment">// A point on the ground</span></div>
<div class="line">            MDouble3 n  = normalized(xyz(ground)); <span class="comment">// Normal of the ground plane</span></div>
<div class="line"></div>
<div class="line">            MDouble3 dp = particle.Position - gp;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Reflect the position and velocity with the ground plain</span></div>
<div class="line">            dp = n * (dot(dp, n) * (1 + elasticity));</div>
<div class="line">            particle.Position = particle.Position - dp;</div>
<div class="line"></div>
<div class="line">            dp = n * (dot(particle.Velocity, n) * (1 + elasticity));</div>
<div class="line">            particle.Velocity = particle.Velocity - dp;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> particle;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>physicsEngine final : <span class="keyword">public</span> <a name="_a12"></a><a class="code" href="#!/url=./cpp_ref/class_m_px_node.html">MPxNode</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a>    <a name="a13"></a><a class="code" href="#!/url=./cpp_ref/class_m_px_node.html#a6e1aa1e50774080d5aee55f20ffa5503">compute</a>(<span class="keyword">const</span> <a name="_a14"></a><a class="code" href="#!/url=./cpp_ref/class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="#!/url=./cpp_ref/class_m_data_block.html">MDataBlock</a>&amp; data) <span class="keyword">override</span>;</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a>    <a name="a15"></a><a class="code" href="#!/url=./cpp_ref/class_m_px_node.html#a93e355c11a2c9a0f19f8d7cfa887af2b">postEvaluation</a>(<span class="keyword">const</span>  <a name="_a16"></a><a class="code" href="#!/url=./cpp_ref/class_m_d_g_context.html">MDGContext</a>&amp; context, <span class="keyword">const</span> <a name="_a17"></a><a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, PostEvaluationType evalType) <span class="keyword">override</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span>       <a name="a18"></a><a class="code" href="#!/url=./cpp_ref/class_m_px_node.html#a6f70ff175ac7ba65cb65aa3b5592f05b">getCacheSetup</a>(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html">MEvaluationNode</a>&amp;, <a name="_a19"></a><a class="code" href="#!/url=./cpp_ref/class_m_node_cache_disabling_info.html">MNodeCacheDisablingInfo</a>&amp;, <a name="_a20"></a><a class="code" href="#!/url=./cpp_ref/class_m_node_cache_setup_info.html">MNodeCacheSetupInfo</a>&amp;, <a name="_a21"></a><a class="code" href="#!/url=./cpp_ref/class_m_object_array.html">MObjectArray</a>&amp;) <span class="keyword">const override</span>;</div>
<div class="line">    <span class="keywordtype">void</span>       <a name="a22"></a><a class="code" href="#!/url=./cpp_ref/class_m_px_node.html#af7be6b397b65f1a96b201e899c923d12">configCache</a>(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html">MEvaluationNode</a>&amp;, <a name="_a23"></a><a class="code" href="#!/url=./cpp_ref/class_m_cache_schema.html">MCacheSchema</a>&amp;) <span class="keyword">const override</span>;</div>
<div class="line"></div>
<div class="line">    <a name="_a24"></a><a class="code" href="#!/url=./cpp_ref/class_m_time_range.html">MTimeRange</a> <a name="a25"></a><a class="code" href="#!/url=./cpp_ref/class_m_px_node.html#a68b5f4da814941edd141ca207d1c7369">transformInvalidationRange</a>(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_plug.html">MPlug</a>&amp; source, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_time_range.html">MTimeRange</a>&amp; input) <span class="keyword">const override</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span>* creator();</div>
<div class="line">    <span class="keyword">static</span> <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> initialize();</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// Attributes</span></div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> MAttributeOf&lt;bool&gt;  aSimulationEnabled; <span class="comment">// [in] When disabled, the current status is frozen as is</span></div>
<div class="line">    <span class="keyword">static</span> MAttributeOf&lt;MTime&gt; aComputeLatency;    <span class="comment">// [in] Apply an artificial slowdown to the compute, `sleep(aComputeLatency)` during MPxNode::compute</span></div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> MAttributeOf&lt;MTime&gt; aInputTime;         <span class="comment">// [in] Always connected to the global time node</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Simulation status, aCurrentStatus(t) is a function of aCurrentStatus(t-1)</span></div>
<div class="line">    <span class="comment">// This attribute must capture all the data of the &#39;previous status&#39; a solver can reply on</span></div>
<div class="line">    <span class="comment">// In order to support &#39;simulation resumption&#39;, this attribute must be cached</span></div>
<div class="line">    <span class="keyword">static</span>  <a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>     aCurrentStatus;</div>
<div class="line">        <span class="keyword">static</span>  MAttributeOf&lt;MTime&gt;    aCurrentTime;     <span class="comment">// [out] The time where the current status is computed</span></div>
<div class="line">        <span class="keyword">static</span>  MAttributeOf&lt;MDouble3&gt; aCurrentPosition; <span class="comment">// [out]</span></div>
<div class="line">        <span class="keyword">static</span>  MAttributeOf&lt;MDouble3&gt; aCurrentVelocity; <span class="comment">// [out]</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initial status</span></div>
<div class="line">    <span class="keyword">static</span>  <a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>     aInitialStatus;</div>
<div class="line">        <span class="keyword">static</span>  MAttributeOf&lt;MTime&gt;    aInitialTime;       <span class="comment">// [in]</span></div>
<div class="line">        <span class="keyword">static</span>  MAttributeOf&lt;MDouble3&gt; aInitialPosition;   <span class="comment">// [in]</span></div>
<div class="line">        <span class="keyword">static</span>  MAttributeOf&lt;MDouble3&gt; aInitialVelocity;   <span class="comment">// [in]</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Other simulation parameters, can be evaluated at any time</span></div>
<div class="line">    <span class="keyword">static</span>  MAttributeOf&lt;double&gt;   aMass;                  <span class="comment">// [in] The mass of this object to decide acceleration</span></div>
<div class="line">    <span class="keyword">static</span>  MAttributeOf&lt;MDouble3&gt; aForce;                 <span class="comment">// [in] External force applied to this object</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/*static MAttributeOf&lt;std::function&lt;MDouble3(MDouble3 position, MDouble3 velocity)&gt; aForceField;*/</span></div>
<div class="line">    <span class="comment">// If a force field is needed as external force</span></div>
<div class="line">    <span class="comment">// It is best to passed it as a &#39;functor&#39; to make sure it does not depend on aCurrentStatus</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// If you added the force field as the result of evaluating the field at the current status</span></div>
<div class="line">    <span class="comment">// E.g. `aFieldForce(t) = f(aCurrentStatus(t), t)`</span></div>
<div class="line">    <span class="comment">// Then it must be added to aCurrentStatus, because it is depend on the previous status of the object</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Passive colliders, can be evaluated at any time</span></div>
<div class="line">    <span class="keyword">static</span>  MAttributeOf&lt;MDouble4&gt; aCollisionPlane;        <span class="comment">// [in] A plane to collide with the particle: (A,B,C,D) in Ax+By+Cz+D&gt;=0 </span></div>
<div class="line">    <span class="keyword">static</span>  MAttributeOf&lt;double&gt;   aCollisionElasticity;   <span class="comment">// [in] The elasticity of the collision plane</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span>  <a name="_a26"></a><a class="code" href="#!/url=./cpp_ref/class_m_type_id.html">MTypeId</a>     id;</div>
<div class="line">    <span class="keyword">static</span>  <a name="_a27"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>     nodeName;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_type_id.html">MTypeId</a> physicsEngine::id = { 0x00081165 };</div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> physicsEngine::nodeName = { <span class="stringliteral">&quot;physicsEngine&quot;</span> };</div>
<div class="line"></div>
<div class="line">MAttributeOf&lt;MTime&gt;    physicsEngine::aInputTime;</div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>                physicsEngine::aCurrentStatus;</div>
<div class="line">MAttributeOf&lt;MTime&gt;    physicsEngine::aCurrentTime;</div>
<div class="line">MAttributeOf&lt;MDouble3&gt; physicsEngine::aCurrentPosition;</div>
<div class="line">MAttributeOf&lt;MDouble3&gt; physicsEngine::aCurrentVelocity;</div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>                physicsEngine::aInitialStatus;</div>
<div class="line">MAttributeOf&lt;MTime&gt;    physicsEngine::aInitialTime;</div>
<div class="line">MAttributeOf&lt;MDouble3&gt; physicsEngine::aInitialPosition;</div>
<div class="line">MAttributeOf&lt;MDouble3&gt; physicsEngine::aInitialVelocity;</div>
<div class="line">MAttributeOf&lt;MDouble3&gt; physicsEngine::aForce;</div>
<div class="line">MAttributeOf&lt;double&gt;   physicsEngine::aMass;</div>
<div class="line">MAttributeOf&lt;MDouble4&gt; physicsEngine::aCollisionPlane;</div>
<div class="line">MAttributeOf&lt;double&gt;   physicsEngine::aCollisionElasticity;</div>
<div class="line">MAttributeOf&lt;bool&gt;     physicsEngine::aSimulationEnabled;</div>
<div class="line">MAttributeOf&lt;MTime&gt;    physicsEngine::aComputeLatency;</div>
<div class="line"></div>
<div class="line"><span class="comment">// When setting infinite values, do not use max()/min() directly, could overflow easily.</span></div>
<div class="line"><span class="keyword">static</span> constexpr MTime::MTick kMaximumTimeTick = std::numeric_limits&lt;MTime::MTick&gt;::max() / 2;</div>
<div class="line"><span class="keyword">static</span> constexpr MTime::MTick kMinimumTimeTick = std::numeric_limits&lt;MTime::MTick&gt;::min() / 2 + 1;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> kMaximumTime = { kMaximumTimeTick / <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(<a name="a28"></a><a class="code" href="#!/url=./cpp_ref/class_m_time.html#a888028acba20a796ec978227cd43f9de">MTime::ticksPerSecond</a>()), <a class="code" href="#!/url=./cpp_ref/class_m_time.html#abceb2331ad056e3c5ad27894199a49eda3091d1a096c28d4993507f167253ebc7">MTime::kSeconds</a> };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> kMinimumTime = { kMinimumTimeTick / <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(<a class="code" href="#!/url=./cpp_ref/class_m_time.html#a888028acba20a796ec978227cd43f9de">MTime::ticksPerSecond</a>()), <a class="code" href="#!/url=./cpp_ref/class_m_time.html#abceb2331ad056e3c5ad27894199a49eda3091d1a096c28d4993507f167253ebc7">MTime::kSeconds</a> };</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> physicsEngine::compute(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="#!/url=./cpp_ref/class_m_data_block.html">MDataBlock</a>&amp; data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using namespace </span>physics;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Only aCurrentStatus is the computable</span></div>
<div class="line">    <span class="keywordflow">if</span> (plug == aCurrentStatus || plug.<a name="a29"></a><a class="code" href="#!/url=./cpp_ref/class_m_plug.html#aa2338038d1c59dc4d35f37f918aabfab">parent</a>() == aCurrentStatus)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> time  = get_input(data, aInputTime);</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> start = get_input(data, aInitialTime);</div>
<div class="line"></div>
<div class="line">        ObjectStatus status;</div>
<div class="line">        status.Time     = get_as_is(data, aCurrentTime);</div>
<div class="line">        status.Position = get_as_is(data, aCurrentPosition);</div>
<div class="line">        status.Velocity = get_as_is(data, aCurrentVelocity);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status.Time &lt;= start || time &lt;= start) {</div>
<div class="line">            <span class="comment">// Setup initial status</span></div>
<div class="line">            status.Time     = start;</div>
<div class="line">            status.Position = get_input(data, aInitialPosition);</div>
<div class="line">            status.Velocity = get_input(data, aInitialVelocity);</div>
<div class="line">        }</div>
<div class="line">        assert(status.Time &gt;= start);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> simulation = get_input(data, aSimulationEnabled);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (simulation &amp;&amp; time &gt; status.Time) {</div>
<div class="line">            <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> dt = time - status.Time;</div>
<div class="line">            MDouble3 force  = get_input(data, aForce);</div>
<div class="line">            <span class="keywordtype">double</span>   mass   = get_input(data, aMass);</div>
<div class="line">            MDouble4 ground = get_input(data, aCollisionPlane);</div>
<div class="line">            <span class="keywordtype">double</span>   damp   = get_input(data, aCollisionElasticity);</div>
<div class="line"></div>
<div class="line">            status = apply_velocity(status, dt, force / mass);</div>
<div class="line">            status = resolve_collision(status, ground, damp);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Emulate the slow computation for real world solver</span></div>
<div class="line">            <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a> latency = get_input(data, aComputeLatency);</div>
<div class="line">            <span class="keywordflow">if</span> (latency &gt; <a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a>{ 0.0 }) {</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::duration&lt;double&gt;{ latency.<a class="code" href="#!/url=./cpp_ref/class_m_time.html#a105d41236561f4d4be6383ced757a429">as</a>(<a class="code" href="#!/url=./cpp_ref/class_m_time.html#abceb2331ad056e3c5ad27894199a49eda3091d1a096c28d4993507f167253ebc7">MTime::kSeconds</a>) });</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        set(data, aCurrentTime,     status.Time);</div>
<div class="line">        set(data, aCurrentPosition, status.Position);</div>
<div class="line">        set(data, aCurrentVelocity, status.Velocity);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> MS::kSuccess;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> MS::kUnknownParameter;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> physicsEngine::postEvaluation(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_d_g_context.html">MDGContext</a>&amp; context, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, PostEvaluationType evalType)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// kEvaluatedDirectly means the data was filled from cache without evaluation</span></div>
<div class="line">    <span class="keywordflow">if</span> (evalType == kEvaluatedDirectly &amp;&amp; context.<a name="a30"></a><a class="code" href="#!/url=./cpp_ref/class_m_d_g_context.html#a761a03ae58bbf2942f90578a0e61ada7">isNormal</a>())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// On foreground restoration</span></div>
<div class="line">        <span class="comment">// You may restore status to external solver here</span></div>
<div class="line">        <span class="comment">// in case editing operations require it</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="#!/url=./cpp_ref/class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> physicsEngine::getCacheSetup(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html">MEvaluationNode</a>&amp; evalNode, <a class="code" href="#!/url=./cpp_ref/class_m_node_cache_disabling_info.html">MNodeCacheDisablingInfo</a>&amp;, <a class="code" href="#!/url=./cpp_ref/class_m_node_cache_setup_info.html">MNodeCacheSetupInfo</a>&amp; setupInfo, <a class="code" href="#!/url=./cpp_ref/class_m_object_array.html">MObjectArray</a>&amp; monitoredAttributes)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordtype">bool</span> simulation;</div>
<div class="line">    <span class="keywordflow">if</span> (evalNode.<a name="a31"></a><a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html#abc632b073f3b3abeb4ca052f20573dd6">dirtyPlugExists</a>(aSimulationEnabled)) {</div>
<div class="line">        <span class="comment">// This attribute is not designed to be animated...</span></div>
<div class="line">        <span class="comment">// It is safer to treat it as running simulation if it is animated</span></div>
<div class="line">        assert(!<span class="stringliteral">&quot;&#39;physicsEngine.simulation&#39; cannot not be animated&quot;</span>);</div>
<div class="line">        simulation = <span class="keyword">true</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keyword">auto</span> data = <span class="keyword">const_cast&lt;</span>physicsEngine*<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;forceCache();</div>
<div class="line">        simulation = get_input(data, aSimulationEnabled);</div>
<div class="line">        monitoredAttributes.<a name="a32"></a><a class="code" href="#!/url=./cpp_ref/class_m_object_array.html#a3694392863ba632bca5d76cbbf190ef5">append</a>(aSimulationEnabled);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// evalNode.dirtyPlugExists(aCurrentStatus) checks if `this.position` or `this.velocity` is connected</span></div>
<div class="line">    <span class="comment">// Otherwise compute(aCurrentStatus) will not be called during evaluation</span></div>
<div class="line">    <span class="comment">// There is no simulation to do in that case</span></div>
<div class="line">    <span class="keywordflow">if</span> (simulation &amp;&amp; evalNode.<a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html#abc632b073f3b3abeb4ca052f20573dd6">dirtyPlugExists</a>(aCurrentStatus)) {</div>
<div class="line">        setupInfo.<a name="a33"></a><a class="code" href="#!/url=./cpp_ref/class_m_node_cache_setup_info.html#a86492224abbc49a832bd0178a3d2fc46">setRequirement</a>(<a name="a34"></a><a class="code" href="#!/url=./cpp_ref/class_m_node_cache_setup_info.html#a7d1b79c8994c6cb481c43cb757d69c2fa046cce158dc36735188793bbd998b660">MNodeCacheSetupInfo::kSimulationSupport</a>,   <span class="keyword">true</span>);</div>
<div class="line">        setupInfo.<a name="a35"></a><a class="code" href="#!/url=./cpp_ref/class_m_node_cache_setup_info.html#aa8e8aa3d550475221be89a27e48df13e">setPreference</a>(<a name="a36"></a><a class="code" href="#!/url=./cpp_ref/class_m_node_cache_setup_info.html#a6860ea2ce3c2eaa8de289c1638d288eba6039051d3a71594da68a931e5dcf7179">MNodeCacheSetupInfo::kWantToCacheByDefault</a>, <span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> physicsEngine::configCache(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html">MEvaluationNode</a>&amp; evalNode, <a class="code" href="#!/url=./cpp_ref/class_m_cache_schema.html">MCacheSchema</a>&amp; schema)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="comment">// Always cache the aCurrentStatus(t)</span></div>
<div class="line">    <span class="comment">// It is needed to compute aCurrentStatus(t+1)</span></div>
<div class="line">    <span class="comment">// Other input attributes must be computable at any time</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Interactions with Maya while background simulation is running may interrupt the simulation and destroy the status data stored in the datablock</span></div>
<div class="line">    <span class="comment">// When the interaction finishes and background simulation is resumed</span></div>
<div class="line">    <span class="comment">// Maya will restore all cached attributes on this node into the datablock</span></div>
<div class="line">    <span class="comment">// For example, the background evaluation are resumed to compute the frame of [5,6,7,...]</span></div>
<div class="line">    <span class="comment">// Before the start of evaluation for frame 5</span></div>
<div class="line">    <span class="comment">// The cached data for frame 4 will be restored into the datablock</span></div>
<div class="line">    <span class="comment">// And thus, one can use `datablock.outpuValue(aCurrentStatus)` in MPxNode::compute() to read the previous-status</span></div>
<div class="line">    <span class="comment">// If aCurrentStatus is not cached and restored, the simulation on frames [5,6,7,...] maybe incorrect</span></div>
<div class="line">    <span class="keywordflow">if</span> (evalNode.<a class="code" href="#!/url=./cpp_ref/class_m_evaluation_node.html#abc632b073f3b3abeb4ca052f20573dd6">dirtyPlugExists</a>(aCurrentStatus))</div>
<div class="line">    {</div>
<div class="line">        schema.<a name="a37"></a><a class="code" href="#!/url=./cpp_ref/class_m_cache_schema.html#a6cc91575e783deab18bb3e1d6721ca02">add</a>(aCurrentStatus);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_time_range.html">MTimeRange</a> physicsEngine::transformInvalidationRange(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_plug.html">MPlug</a>&amp; source, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_time_range.html">MTimeRange</a>&amp; input)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keyword">auto</span> data = <span class="keyword">const_cast&lt;</span>physicsEngine*<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;forceCache();</div>
<div class="line">    <span class="keyword">auto</span> start = get_as_is(data, aInitialTime);</div>
<div class="line">    <span class="comment">// Check if simulation is enabled, if the data is dirty, treat it as enable</span></div>
<div class="line">    <span class="keyword">auto</span> simulation = get_as_is(data, aSimulationEnabled) || !data.<a name="a38"></a><a class="code" href="#!/url=./cpp_ref/class_m_data_block.html#a09f4b5726085e604cb22c22a25aaf6b9">isClean</a>(aSimulationEnabled);</div>
<div class="line">    <span class="comment">// If simulation is enabled, and the input invalidation range overlap with the simulation time range</span></div>
<div class="line">    <span class="keywordflow">if</span> (simulation &amp;&amp; input.<a name="a39"></a><a class="code" href="#!/url=./cpp_ref/class_m_time_range.html#a36406ba0e13e74604af20b2fbe0453d1">intersects</a>(start, kMaximumTime)) {</div>
<div class="line">        <span class="comment">// Ensure all frames after the first affected frame are invalidated</span></div>
<div class="line">        <span class="keywordflow">return</span> input | <a class="code" href="#!/url=./cpp_ref/class_m_time_range.html">MTimeRange</a>{ input.<a name="a40"></a><a class="code" href="#!/url=./cpp_ref/class_m_time_range.html#a688f63fcfcfd0f38f055bca3cb99a060">bounds</a>().<a name="a41"></a><a class="code" href="#!/url=./cpp_ref/struct_m_closed_time_interval.html#a9b74600dca663b955af296393f91576d">min</a>, kMaximumTime };</div>
<div class="line"></div>
<div class="line">        <span class="comment">// For nodes does not cache internal status and thus cannot resume simulation</span></div>
<div class="line">        <span class="comment">// We have to invalidate the entire simulation range to effectively restart simulation</span></div>
<div class="line">        <span class="comment">// return input | MTimeRange{ start, kMaximumTime };</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// The invalidation range does not affect the variables in simulation time range, pass through</span></div>
<div class="line">    <span class="keywordflow">return</span> input;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span>* physicsEngine::creator()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> physicsEngine();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> physicsEngine::initialize()</div>
<div class="line">{</div>
<div class="line">    <a name="_a42"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html">MFnNumericAttribute</a> nAttr;</div>
<div class="line">    <a name="_a43"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html">MFnUnitAttribute</a>    uAttr;</div>
<div class="line">    <a name="_a44"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html">MFnCompoundAttribute</a> cAttr;</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a>             status;</div>
<div class="line"></div>
<div class="line">    aSimulationEnabled = nAttr.<a name="a45"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;simulation&quot;</span>, <span class="stringliteral">&quot;se&quot;</span>, <a name="a46"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7a8cfc0ab572a96edfc9db7c02f0d025d7">MFnNumericData::kBoolean</a>); nAttr.<a name="a47"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#aae3f2fbbbce06e006f1838a1fb6fdcdd">setDefault</a>(<span class="keyword">true</span>); nAttr.<a name="a48"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>(<span class="keyword">false</span>); nAttr.<a name="a49"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>); nAttr.<a name="a50"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>); nAttr.<a name="a51"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>); nAttr.<a name="a52"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line">    aComputeLatency = uAttr.<a name="a53"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a31f804de81a968aa11b510a6231e7874">create</a>(<span class="stringliteral">&quot;computeLatency&quot;</span>, <span class="stringliteral">&quot;cl&quot;</span>, <a name="a54"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a1d1cfd8ffb84e947f82999c682b666a7a65c3a8bb75ba1a57e36c86855169752e">MFnUnitAttribute::kTime</a>); uAttr.<a name="a55"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a02a46e1b4ae48c38d85678a8611e3e77">setDefault</a>(<a class="code" href="#!/url=./cpp_ref/class_m_time.html">MTime</a>{0.01,<a class="code" href="#!/url=./cpp_ref/class_m_time.html#abceb2331ad056e3c5ad27894199a49eda3091d1a096c28d4993507f167253ebc7">MTime::kSeconds</a>}); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    aInputTime = uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a31f804de81a968aa11b510a6231e7874">create</a>(<span class="stringliteral">&quot;inputTime&quot;</span>, <span class="stringliteral">&quot;ipt&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a1d1cfd8ffb84e947f82999c682b666a7a65c3a8bb75ba1a57e36c86855169752e">MFnUnitAttribute::kTime</a>, 0.0); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">false</span>); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">false</span>); uAttr.<a name="a56"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ab8e48be1f1009a30d0e40dfcaf9e649d">setHidden</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    aCurrentStatus = cAttr.<a name="a57"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a94a6d5e93a85fb18bc7accc18ee0d9f6">create</a>(<span class="stringliteral">&quot;status&quot;</span>, <span class="stringliteral">&quot;s&quot;</span>);</div>
<div class="line">        aCurrentTime     = uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a31f804de81a968aa11b510a6231e7874">create</a>(<span class="stringliteral">&quot;time&quot;</span>, <span class="stringliteral">&quot;t&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a1d1cfd8ffb84e947f82999c682b666a7a65c3a8bb75ba1a57e36c86855169752e">MFnUnitAttribute::kTime</a>); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a02a46e1b4ae48c38d85678a8611e3e77">setDefault</a>(kMinimumTime); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">false</span>); uAttr.<a name="a58"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ab1986dcbce4e2fd86c5cb0bff5119dc0">setConnectable</a>(<span class="keyword">false</span>); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ab8e48be1f1009a30d0e40dfcaf9e649d">setHidden</a>(<span class="keyword">true</span>);</div>
<div class="line">        aCurrentPosition = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;position&quot;</span>, <span class="stringliteral">&quot;p&quot;</span>, <a name="a59"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7add817d1d2e1e1d24ac2e2819a58e8f99">MFnNumericData::k3Double</a>);</div>
<div class="line">        aCurrentVelocity = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;velocity&quot;</span>, <span class="stringliteral">&quot;v&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7add817d1d2e1e1d24ac2e2819a58e8f99">MFnNumericData::k3Double</a>);</div>
<div class="line">        cAttr.<a name="a60"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a45469146fcfb96cdc96ad3a07df5dfa7">addChild</a>(aCurrentTime);</div>
<div class="line">        cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a45469146fcfb96cdc96ad3a07df5dfa7">addChild</a>(aCurrentPosition);</div>
<div class="line">        cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a45469146fcfb96cdc96ad3a07df5dfa7">addChild</a>(aCurrentVelocity);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">false</span>);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>(<span class="keyword">false</span>);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    aInitialStatus = cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a94a6d5e93a85fb18bc7accc18ee0d9f6">create</a>(<span class="stringliteral">&quot;initialStatus&quot;</span>, <span class="stringliteral">&quot;is&quot;</span>);</div>
<div class="line">        aInitialTime     = uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a31f804de81a968aa11b510a6231e7874">create</a>(<span class="stringliteral">&quot;initialTime&quot;</span>, <span class="stringliteral">&quot;it&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_unit_attribute.html#a1d1cfd8ffb84e947f82999c682b666a7a65c3a8bb75ba1a57e36c86855169752e">MFnUnitAttribute::kTime</a>, 1.0); uAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>(<span class="keyword">false</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line">        aInitialPosition = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;initialPosition&quot;</span>, <span class="stringliteral">&quot;ip&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7add817d1d2e1e1d24ac2e2819a58e8f99">MFnNumericData::k3Double</a>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#aae3f2fbbbce06e006f1838a1fb6fdcdd">setDefault</a>(0.0, 10.0, 0.0); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>(<span class="keyword">false</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line">        aInitialVelocity = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;initialVelocity&quot;</span>, <span class="stringliteral">&quot;iv&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7add817d1d2e1e1d24ac2e2819a58e8f99">MFnNumericData::k3Double</a>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#aae3f2fbbbce06e006f1838a1fb6fdcdd">setDefault</a>(1.0, 0.0, 0.0); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>(<span class="keyword">false</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line">        cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a45469146fcfb96cdc96ad3a07df5dfa7">addChild</a>(aInitialTime);</div>
<div class="line">        cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a45469146fcfb96cdc96ad3a07df5dfa7">addChild</a>(aInitialPosition);</div>
<div class="line">        cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_compound_attribute.html#a45469146fcfb96cdc96ad3a07df5dfa7">addChild</a>(aInitialVelocity);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>);</div>
<div class="line">    cAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    aForce               = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;force&quot;</span>, <span class="stringliteral">&quot;f&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7add817d1d2e1e1d24ac2e2819a58e8f99">MFnNumericData::k3Double</a>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#aae3f2fbbbce06e006f1838a1fb6fdcdd">setDefault</a>(0.0, -9.8, 0.0); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line">    aMass                = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;mass&quot;</span>, <span class="stringliteral">&quot;m&quot;</span>, <a name="a61"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7acd70f5d2b5e8c1bb8e83b0482a33e518">MFnNumericData::kDouble</a>, 1.0); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    aCollisionPlane      = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;collisionPlane&quot;</span>, <span class="stringliteral">&quot;cp&quot;</span>, <a name="a62"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7a3dfe68bf09c3e609cdb4c897dfcf3dbe">MFnNumericData::k4Double</a>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#aae3f2fbbbce06e006f1838a1fb6fdcdd">setDefault</a>(0.0, 1.0, 0.0, 0.0); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line">    aCollisionElasticity = nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_attribute.html#a5c08a5ce5e7123cc444c95a0e4a50f29">create</a>(<span class="stringliteral">&quot;collisionElasticity&quot;</span>, <span class="stringliteral">&quot;ce&quot;</span>, <a class="code" href="#!/url=./cpp_ref/class_m_fn_numeric_data.html#a1d1cfd8ffb84e947f82999c682b666a7acd70f5d2b5e8c1bb8e83b0482a33e518">MFnNumericData::kDouble</a>, 0.8); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#af41aae76c0dc31dbcd1f4ecea52d694e">setReadable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">true</span>); nAttr.<a class="code" href="#!/url=./cpp_ref/class_m_fn_attribute.html#ace425962bea0677111b837b27f0c72f3">setChannelBox</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    status = addAttribute(aSimulationEnabled);</div>
<div class="line">    status = addAttribute(aComputeLatency);</div>
<div class="line">    status = addAttribute(aInputTime);</div>
<div class="line">    status = addAttribute(aCurrentStatus);</div>
<div class="line">    status = addAttribute(aInitialStatus);</div>
<div class="line">    status = addAttribute(aForce);</div>
<div class="line">    status = addAttribute(aMass);</div>
<div class="line">    status = addAttribute(aCollisionPlane);</div>
<div class="line">    status = addAttribute(aCollisionElasticity);</div>
<div class="line"></div>
<div class="line">    status = attributeAffects(aSimulationEnabled,   aCurrentStatus);</div>
<div class="line">    status = attributeAffects(aInputTime,           aCurrentStatus);</div>
<div class="line">    status = attributeAffects(aInitialStatus,       aCurrentStatus);</div>
<div class="line">    status = attributeAffects(aForce,               aCurrentStatus);</div>
<div class="line">    status = attributeAffects(aMass,                aCurrentStatus);</div>
<div class="line">    status = attributeAffects(aCollisionPlane,      aCurrentStatus);</div>
<div class="line">    status = attributeAffects(aCollisionElasticity, aCurrentStatus);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> MS::kSuccess;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">MCallbackId gNodeAddedCallbackId;</div>
<div class="line"><span class="comment">// Plug-in entry points</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> initializePlugin(<a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a> obj)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a>   status;</div>
<div class="line">    <a name="_a63"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_plugin.html">MFnPlugin</a> plugin(obj, PLUGIN_COMPANY, <span class="stringliteral">&quot;1.0&quot;</span>, <span class="stringliteral">&quot;Any&quot;</span>);</div>
<div class="line"></div>
<div class="line">    status = plugin.registerNode(</div>
<div class="line">        physicsEngine::nodeName,</div>
<div class="line">        physicsEngine::id,</div>
<div class="line">        physicsEngine::creator,</div>
<div class="line">        physicsEngine::initialize</div>
<div class="line">    );</div>
<div class="line">    <span class="keywordflow">if</span> (!status) {</div>
<div class="line">        status.<a name="a64"></a><a class="code" href="#!/url=./cpp_ref/class_m_status.html#a1f01a4748fea4d8bcced082df83f804d">perror</a>(<span class="stringliteral">&quot;registerNode&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> status;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Ensure physicsEngine.inputTime is always connected to time node</span></div>
<div class="line">    gNodeAddedCallbackId = <a name="a65"></a><a class="code" href="#!/url=./cpp_ref/class_m_d_g_message.html#aef31b6b5f1f5dca4f49c848dfff9e566">MDGMessage::addNodeAddedCallback</a>([](<a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>&amp; node, <span class="keywordtype">void</span>*) {</div>
<div class="line">        <span class="keyword">static</span> <a class="code" href="#!/url=./cpp_ref/class_m_plug.html">MPlug</a> timeOutPlug;</div>
<div class="line">        <span class="keywordflow">if</span> (timeOutPlug.<a name="a66"></a><a class="code" href="#!/url=./cpp_ref/class_m_plug.html#ab7ec149d38b7c29ca55c5aa7b407d8f9">isNull</a>())</div>
<div class="line">        {</div>
<div class="line">            <a name="_a67"></a><a class="code" href="#!/url=./cpp_ref/class_m_it_dependency_nodes.html">MItDependencyNodes</a> itr { <a name="a68"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn.html#a1d1cfd8ffb84e947f82999c682b666a7a65c3a8bb75ba1a57e36c86855169752e">MFn::kTime</a> };</div>
<div class="line">            <a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a> timeNode = itr.thisNode();</div>
<div class="line">            <a name="_a69"></a><a class="code" href="#!/url=./cpp_ref/class_m_fn_dependency_node.html">MFnDependencyNode</a> fDN(timeNode);</div>
<div class="line">            timeOutPlug = { timeNode, fDN.attribute(<span class="stringliteral">&quot;outTime&quot;</span>) };</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_fn_dependency_node.html">MFnDependencyNode</a> fDN(node);</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_plug.html">MPlug</a> timeInPlug { node, physicsEngine::aInputTime };</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!timeOutPlug.<a class="code" href="#!/url=./cpp_ref/class_m_plug.html#ab7ec149d38b7c29ca55c5aa7b407d8f9">isNull</a>() &amp;&amp; !timeInPlug.isNull()) {</div>
<div class="line">            <a name="_a70"></a><a class="code" href="#!/url=./cpp_ref/class_m_d_g_modifier.html">MDGModifier</a> modifier;</div>
<div class="line">            modifier.<a name="a71"></a><a class="code" href="#!/url=./cpp_ref/class_m_d_g_modifier.html#afbd18f066f70fcd1864ddb4af91f3c7b">connect</a>(timeOutPlug, timeInPlug);</div>
<div class="line">            modifier.<a name="a72"></a><a class="code" href="#!/url=./cpp_ref/class_m_d_g_modifier.html#a984345cd272bc1a32a9fc2e93a6678b2">doIt</a>();</div>
<div class="line">        }</div>
<div class="line">    }, physicsEngine::nodeName);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a> uninitializePlugin(<a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a> obj)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_status.html">MStatus</a>   status;</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_fn_plugin.html">MFnPlugin</a> plugin(obj);</div>
<div class="line"></div>
<div class="line">    <a name="a73"></a><a class="code" href="#!/url=./cpp_ref/class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MDGMessage::removeCallback</a>(gNodeAddedCallbackId);</div>
<div class="line"></div>
<div class="line">    status = plugin.deregisterNode(physicsEngine::id);</div>
<div class="line">    <span class="keywordflow">if</span> (!status) {</div>
<div class="line">        status.<a class="code" href="#!/url=./cpp_ref/class_m_status.html#a1f01a4748fea4d8bcced082df83f804d">perror</a>(<span class="stringliteral">&quot;deregisterNode&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> status;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->

      <div class="footer-block"><a href="../html/ac.cmtdialog.htm" class="comments-anchor" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
   </div></body>
</html>
