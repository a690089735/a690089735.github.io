<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
   <head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script>
      <title>C++ API Reference: cgFx/cgfxEffectDef.cpp</title>
      
	  
      
      
      
      
      
      
      
    

</head>
   <body height="100%"><div class="body_content" id="body-content"><link rel="stylesheet" type="text/css" href="cpp_ref/navtree.css"><link rel="stylesheet" type="text/css" href="cpp_ref/doxygen.css"><link rel="stylesheet" type="text/css" href="cpp_ref/tabs.css"><link rel="stylesheet" type="text/css" href="style/adsk.cpm.css"><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('cg_fx_2cgfx_effect_def_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script>
      <div>
         <div class="head">
            <h1>C++ API Reference: cgFx/cgfxEffectDef.cpp</h1>
         </div>

<div id="top"><!-- do not remove this div, it is closed by doxygen! -->

<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->

  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="#!/url=./cpp_ref/index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="#!/url=./cpp_ref/pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="#!/url=./cpp_ref/modules.html"><span>Modules</span></a></li>
      <li><a href="#!/url=./cpp_ref/namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="#!/url=./cpp_ref/annotated.html"><span>Classes</span></a></li>
      <li><a href="#!/url=./cpp_ref/examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="cpp_ref/search/mag_sel.png" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()" alt="">
          <input type="text" id="MSearchField" value="Search" accesskey="S" onfocus="searchBox.OnSearchFieldFocus(true)" onblur="searchBox.OnSearchFieldFocus(false)" onkeyup="searchBox.OnSearchFieldChange(event)">
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="cpp_ref/search/close.png" alt=""></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" class="ui-resizable-handle">
  </div>
</div>

<div id="doc-content">
<!-- window showing the filter options -->


<!-- iframe showing the search results (closed by default) -->


<div class="header">
  <div class="headertitle">
<div class="title">cgFx/cgfxEffectDef.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">//-</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">// Copyright 2015 Autodesk, Inc.  All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk</span></div>
<div class="line"><span class="comment">// license agreement provided at the time of installation or download,</span></div>
<div class="line"><span class="comment">// or which otherwise accompanies this software in either electronic</span></div>
<div class="line"><span class="comment">// or hard copy form.</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">//+</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHardwareRenderer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGlobal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cgfxEffectDef.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cgfxFindImage.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cgfxShaderNode.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cgfxShaderCommon.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#   include &lt;sys/timeb.h&gt;</span></div>
<div class="line"><span class="preprocessor">#   include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor">#   define stricmp strcasecmp</span></div>
<div class="line"><span class="preprocessor">#   define strnicmp strncasecmp</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#undef ENABLE_TRACE_API_CALLS</span></div>
<div class="line"><span class="preprocessor">#ifdef ENABLE_TRACE_API_CALLS</span></div>
<div class="line"><span class="preprocessor">#define TRACE_API_CALLS(x) cerr &lt;&lt; &quot;cgfxShader: &quot;&lt;&lt;(x)&lt;&lt;&quot;\n&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define TRACE_API_CALLS(x)</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// A per-vertex attribute on a shader</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line">cgfxVertexAttribute::cgfxVertexAttribute()</div>
<div class="line"> : fNext( NULL), fSourceType( kUnknown), fSourceIndex( 0), refcount(0)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxVertexAttribute::release()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    --refcount;</div>
<div class="line">    <span class="keywordflow">if</span> (refcount &lt;= 0)</div>
<div class="line">    {</div>
<div class="line">        M_CHECK( refcount == 0 );</div>
<div class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// A varying parameter to a pass</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line">cgfxVaryingParameter::cgfxVaryingParameter(CGparameter parameter)</div>
<div class="line"> :  fParameter( parameter),</div>
<div class="line">    fVertexAttribute( NULL),</div>
<div class="line">    fVertexStructure( NULL),</div>
<div class="line">    fNext( NULL)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( parameter)</div>
<div class="line">    {</div>
<div class="line">        fName = cgGetParameterName( parameter);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">cgfxVaryingParameter::~cgfxVaryingParameter()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> fVertexStructure;</div>
<div class="line">    <span class="keyword">delete</span> fNext;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxVaryingParameter::setupAttributes( cgfxRCPtr&lt;cgfxVertexAttribute&gt;&amp; vertexAttributes, CGprogram program)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Make sure our parameter name is acceptable is a Maya attribute name</span></div>
<div class="line">    <a name="_a0"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> attrName = fName;</div>
<div class="line">    <span class="keywordtype">int</span> lastDot = attrName.<a name="a1"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html#a2f0c58e22c8c209d0ea924de9913993a">rindex</a>( <span class="charliteral">&#39;.&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>( lastDot &gt;= 0)</div>
<div class="line">        attrName = attrName.<a name="a2"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html#a41ba57372bc1082383b4f1929a8030fa">substring</a>( lastDot + 1, attrName.<a name="a3"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() - 1);</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> semanticName = cgGetParameterSemantic( fParameter);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> semantic(semanticName);</div>
<div class="line">    cgGetParameterSemantic( fParameter);</div>
<div class="line">    semantic.toUpperCase();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Is this varying parameter packed or atomic?</span></div>
<div class="line">    CGtype type = cgGetNamedUserType( program, attrName.<a name="a4"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>());</div>
<div class="line">    <span class="keywordflow">if</span>( type != CG_UNKNOWN_TYPE)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// It&#39;s packed: explode the inputs into the structure elements</span></div>
<div class="line">        CGcontext context = cgGetProgramContext( program); </div>
<div class="line">        CGparameter packing = cgCreateParameter( context, type);</div>
<div class="line">        fVertexStructure = <span class="keyword">new</span> cgfxVaryingParameterStructure();</div>
<div class="line">        fVertexStructure-&gt;fLength = 0;</div>
<div class="line">        fVertexStructure-&gt;fSize = 0;</div>
<div class="line">        CGparameter element = cgGetFirstStructParameter( packing);</div>
<div class="line">        <span class="keywordflow">while</span>( element)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> elementName = cgGetParameterName( element);</div>
<div class="line">            <span class="keywordtype">int</span> lastDot = elementName.<a class="code" href="#!/url=./cpp_ref/class_m_string.html#a2f0c58e22c8c209d0ea924de9913993a">rindex</a>( <span class="charliteral">&#39;.&#39;</span>);</div>
<div class="line">            <span class="keywordflow">if</span>( lastDot &gt;= 0)</div>
<div class="line">                elementName = elementName.<a class="code" href="#!/url=./cpp_ref/class_m_string.html#a41ba57372bc1082383b4f1929a8030fa">substring</a>( lastDot + 1, elementName.<a class="code" href="#!/url=./cpp_ref/class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() - 1);</div>
<div class="line">            cgfxRCPtr&lt;cgfxVertexAttribute&gt; attr = setupAttribute( elementName, semantic, element, vertexAttributes);</div>
<div class="line">            fVertexStructure-&gt;fElements[ fVertexStructure-&gt;fLength].fVertexAttribute = attr;</div>
<div class="line">            <span class="keywordtype">int</span> size = cgGetParameterRows( element) * cgGetParameterColumns( element);</div>
<div class="line">            CGtype type = cgGetParameterBaseType( element);</div>
<div class="line">            <span class="keywordflow">if</span>( type == CG_FLOAT) size *= <span class="keyword">sizeof</span>( GLfloat);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( type == CG_INT) size *= <span class="keyword">sizeof</span>( GLint);</div>
<div class="line">            fVertexStructure-&gt;fElements[ fVertexStructure-&gt;fLength].fSize = size;</div>
<div class="line">            fVertexStructure-&gt;fLength++;</div>
<div class="line">            fVertexStructure-&gt;fSize += size;</div>
<div class="line">            element = cgGetNextParameter( element);</div>
<div class="line">        }</div>
<div class="line">        cgDestroyParameter( packing); </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// It&#39;s atomic - create a single, simple input</span></div>
<div class="line">        fVertexAttribute = setupAttribute( attrName, semantic, fParameter, vertexAttributes);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Now pull apart the semantic string to work out where to bind</span></div>
<div class="line">    <span class="comment">// this value in open GL (as the automagic binding through cgGL</span></div>
<div class="line">    <span class="comment">// didn&#39;t work so well when this was written)</span></div>
<div class="line">    <span class="keywordtype">int</span> radix = 1;</div>
<div class="line">    fGLIndex = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length = semantic.length();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* str = semantic.asChar();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If sematic is NULL then stop here, bug 327649</span></div>
<div class="line">    <span class="keywordflow">if</span> (length == 0) {</div>
<div class="line">         fGLType = glRegister::kUnknown;</div>
<div class="line">         <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(;;)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> c = str[ length - 1];</div>
<div class="line">        <span class="keywordflow">if</span>( c &lt; &#39;0&#39; || c &gt; <span class="charliteral">&#39;9&#39;</span>) <span class="keywordflow">break</span>;</div>
<div class="line">        fGLIndex += radix * (c - <span class="charliteral">&#39;0&#39;</span>);</div>
<div class="line">        radix *= 10;</div>
<div class="line">        --length;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>( semantic.length() != length)</div>
<div class="line">        semantic = semantic.substring( 0, length - 1);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Determine the semantic and setup the gl binding type we should use</span></div>
<div class="line">    <span class="comment">// to set this parameter. If there&#39;s a sensible default value, set that</span></div>
<div class="line">    <span class="comment">// while we&#39;re here.</span></div>
<div class="line">    <span class="comment">// Note there is no need to set the source type, this gets determined</span></div>
<div class="line">    <span class="comment">// when the vertex attribute sources are analysed</span></div>
<div class="line">    <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;POSITION&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kPosition;</div>
<div class="line">        fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;position&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;NORMAL&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kNormal;</div>
<div class="line">        <span class="keywordflow">if</span>( fVertexAttribute.isNull() == false ) </div>
<div class="line">            fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;normal&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;TEXCOORD&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kTexCoord;</div>
<div class="line">        <span class="keywordflow">if</span>( fVertexAttribute.isNull() == false ) </div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>( attrName.<a name="a5"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html#a56fd78fe1cd1bc285cc8c336ed977d7e">toLowerCase</a>() == <span class="stringliteral">&quot;tangent&quot;</span>)</div>
<div class="line">                fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;tangent:map1&quot;</span>;</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( attrName.<a class="code" href="#!/url=./cpp_ref/class_m_string.html#a56fd78fe1cd1bc285cc8c336ed977d7e">toLowerCase</a>() == <span class="stringliteral">&quot;binormal&quot;</span>)</div>
<div class="line">                fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;binormal:map1&quot;</span>;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;uv:map1&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;TANGENT&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kTexCoord;</div>
<div class="line">        fGLIndex += 6; <span class="comment">// TANGENT is TEXCOORD6</span></div>
<div class="line">        <span class="keywordflow">if</span>( fVertexAttribute.isNull() == false ) </div>
<div class="line">            fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;tangent:map1&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;BINORMAL&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kTexCoord;</div>
<div class="line">        fGLIndex += 7; <span class="comment">// BINORMAL is TEXCOORD7</span></div>
<div class="line">        <span class="keywordflow">if</span>( fVertexAttribute.isNull() == false ) </div>
<div class="line">            fVertexAttribute-&gt;fSourceName = <span class="stringliteral">&quot;binormal:map1&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;COLOR&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = fGLIndex == 1 ? glRegister::kSecondaryColor : glRegister::kColor;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;ATTR&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kVertexAttrib;</div>
<div class="line">        <span class="keywordflow">if</span>( fVertexAttribute.isNull() == false ) </div>
<div class="line">        {</div>
<div class="line">            fVertexAttribute-&gt;fSourceName = semanticName;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( semantic == <span class="stringliteral">&quot;PSIZE&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kVertexAttrib;</div>
<div class="line">        fGLIndex = 6;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        fGLType = glRegister::kUnknown;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxRCPtr&lt;cgfxVertexAttribute&gt; cgfxVaryingParameter::setupAttribute(</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> name, </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; semantic, </div>
<div class="line">    CGparameter parameter, </div>
<div class="line">    cgfxRCPtr&lt;cgfxVertexAttribute&gt;&amp; vertexAttributes</div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Does a varying parameter of this name already exist?</span></div>
<div class="line">    cgfxRCPtr&lt;cgfxVertexAttribute&gt;* attribute = &amp;vertexAttributes;</div>
<div class="line">    <span class="keywordflow">while</span>( attribute-&gt;isNull() == false )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( (*attribute)-&gt;fName == name)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> *attribute;</div>
<div class="line">        }</div>
<div class="line">        attribute = &amp;(*attribute)-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Add a new input for this parameter</span></div>
<div class="line">    cgfxRCPtr&lt;cgfxVertexAttribute&gt; attr = cgfxRCPtr&lt;cgfxVertexAttribute&gt;(<span class="keyword">new</span> cgfxVertexAttribute());</div>
<div class="line">    *attribute = attr;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Setup the varying parameter description</span></div>
<div class="line">    attr-&gt;fName = name;</div>
<div class="line">    attr-&gt;fType = cgGetTypeString( cgGetParameterType( parameter));</div>
<div class="line">    attr-&gt;fSemantic = semantic;</div>
<div class="line">    <span class="keywordflow">return</span> attr;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxVaryingParameter::bind(</div>
<div class="line">    <span class="keyword">const</span> <a name="_a6"></a><a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html">MDagPath</a>&amp; shape, cgfxStructureCache* cache,</div>
<div class="line">    <span class="keywordtype">int</span> vertexCount, <span class="keyword">const</span> <span class="keywordtype">float</span> * vertexArray,</div>
<div class="line">    <span class="keywordtype">int</span> normalsPerVertex, <span class="keywordtype">int</span> normalCount, <span class="keyword">const</span> <span class="keywordtype">float</span> ** normalArrays,</div>
<div class="line">    <span class="keywordtype">int</span> colorCount, <span class="keyword">const</span> <span class="keywordtype">float</span> ** colorArrays,</div>
<div class="line">    <span class="keywordtype">int</span> texCoordCount, <span class="keyword">const</span> <span class="keywordtype">float</span> ** texCoordArrays</div>
<div class="line">)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">if</span>( fVertexAttribute.isNull() == <span class="keyword">false</span>  &amp;&amp; fParameter)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">switch</span>( fVertexAttribute-&gt;fSourceType)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">case</span> cgfxVertexAttribute::kPosition:</div>
<div class="line">                result = bind( vertexArray, 3);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> cgfxVertexAttribute::kNormal:</div>
<div class="line">                <span class="keywordflow">if</span>( normalCount &gt; 0 &amp;&amp; normalArrays[ 0])</div>
<div class="line">                    result = bind( normalArrays[0], 3);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> cgfxVertexAttribute::kUV:</div>
<div class="line">                <span class="keywordflow">if</span>( texCoordCount &gt; fVertexAttribute-&gt;fSourceIndex &amp;&amp; texCoordArrays[ fVertexAttribute-&gt;fSourceIndex])</div>
<div class="line">                    result = bind( texCoordArrays[ fVertexAttribute-&gt;fSourceIndex], 2);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> cgfxVertexAttribute::kTangent:</div>
<div class="line">                <span class="keywordflow">if</span>( normalCount &gt;= normalsPerVertex * fVertexAttribute-&gt;fSourceIndex + 1 &amp;&amp; normalArrays[ normalsPerVertex * fVertexAttribute-&gt;fSourceIndex + 1])</div>
<div class="line">                    result = bind( normalArrays[ normalsPerVertex * fVertexAttribute-&gt;fSourceIndex + 1], 3);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> cgfxVertexAttribute::kBinormal:</div>
<div class="line">                <span class="keywordflow">if</span>( normalCount &gt;= normalsPerVertex * fVertexAttribute-&gt;fSourceIndex + 2 &amp;&amp; normalArrays[ normalsPerVertex * fVertexAttribute-&gt;fSourceIndex + 2])</div>
<div class="line">                    result = bind( normalArrays[ normalsPerVertex * fVertexAttribute-&gt;fSourceIndex + 2], 3);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> cgfxVertexAttribute::kColor:</div>
<div class="line">                <span class="keywordflow">if</span>( colorCount &gt; fVertexAttribute-&gt;fSourceIndex &amp;&amp; colorArrays[ fVertexAttribute-&gt;fSourceIndex])</div>
<div class="line">                    result = bind( colorArrays[ fVertexAttribute-&gt;fSourceIndex], 4);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fVertexStructure &amp;&amp; fParameter &amp;&amp; vertexCount)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Build a unique name for the contents of this structure</span></div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> structureName;</div>
<div class="line">        structureName += fVertexStructure-&gt;fSize;</div>
<div class="line">        <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; fVertexStructure-&gt;fLength; i++)</div>
<div class="line">        {</div>
<div class="line">                cgfxRCPtr&lt;cgfxVertexAttribute&gt; vertexAttribute = fVertexStructure-&gt;fElements[ i].fVertexAttribute;</div>
<div class="line">                <span class="keywordflow">if</span>( vertexAttribute.isNull() == false ) structureName += fVertexStructure-&gt;fElements[ i].fVertexAttribute-&gt;fSourceName;</div>
<div class="line">                structureName += fVertexStructure-&gt;fElements[ i].fSize;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// See if this data already exists in the cache</span></div>
<div class="line">        <span class="keywordtype">char</span>* data = cache-&gt;findEntry(shape, structureName);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// If we couldn&#39;t find it, add it to the cache</span></div>
<div class="line">        <span class="keywordflow">if</span> (!data)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Allocate storage for this structure</span></div>
<div class="line">            <span class="comment">//printf( &quot;Added new cache entry for %s on %s\n&quot;, structureName.asChar(), shape.fullPathName().asChar());</span></div>
<div class="line">            data = cache-&gt;addEntry(</div>
<div class="line">                shape, structureName, fVertexStructure-&gt;fSize, vertexCount);</div>
<div class="line">            <span class="keywordtype">char</span>* dest = data;</div>
<div class="line">            <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; fVertexStructure-&gt;fLength; i++)</div>
<div class="line">            {</div>
<div class="line">                cgfxRCPtr&lt;cgfxVertexAttribute&gt; vertexAttribute = fVertexStructure-&gt;fElements[ i].fVertexAttribute;</div>
<div class="line">                <span class="keywordflow">if</span>( vertexAttribute.isNull() == false )</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">char</span>* src = NULL;</div>
<div class="line">                    <span class="keywordtype">int</span> size = 0;</div>
<div class="line">                    <span class="keywordflow">switch</span>( vertexAttribute-&gt;fSourceType)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">case</span> cgfxVertexAttribute::kPosition:</div>
<div class="line">                            src = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)vertexArray;</div>
<div class="line">                            size = 3 * <span class="keyword">sizeof</span>( float);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">case</span> cgfxVertexAttribute::kNormal:</div>
<div class="line">                            <span class="keywordflow">if</span>( normalCount &gt; 0 &amp;&amp; normalArrays[ 0])</div>
<div class="line">                            {</div>
<div class="line">                                src = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)normalArrays[0];</div>
<div class="line">                                size = 3 * <span class="keyword">sizeof</span>( float);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">case</span> cgfxVertexAttribute::kUV:</div>
<div class="line">                            <span class="keywordflow">if</span>( texCoordCount &gt; vertexAttribute-&gt;fSourceIndex &amp;&amp; texCoordArrays[ vertexAttribute-&gt;fSourceIndex])</div>
<div class="line">                            {</div>
<div class="line">                                src = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)texCoordArrays[ vertexAttribute-&gt;fSourceIndex];</div>
<div class="line">                                size = 2 * <span class="keyword">sizeof</span>( <span class="keywordtype">float</span>);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">case</span> cgfxVertexAttribute::kTangent:</div>
<div class="line">                            <span class="keywordflow">if</span>( normalCount &gt;= normalsPerVertex * vertexAttribute-&gt;fSourceIndex + 1 &amp;&amp; normalArrays[ normalsPerVertex * vertexAttribute-&gt;fSourceIndex + 1])</div>
<div class="line">                            {</div>
<div class="line">                                src = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)normalArrays[ normalsPerVertex * vertexAttribute-&gt;fSourceIndex + 1];</div>
<div class="line">                                size = 3 * <span class="keyword">sizeof</span>( <span class="keywordtype">float</span>);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">case</span> cgfxVertexAttribute::kBinormal:</div>
<div class="line">                            <span class="keywordflow">if</span>( normalCount &gt;= normalsPerVertex * vertexAttribute-&gt;fSourceIndex + 2 &amp;&amp; normalArrays[ normalsPerVertex * vertexAttribute-&gt;fSourceIndex + 2])</div>
<div class="line">                            {</div>
<div class="line">                                src = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)normalArrays[ normalsPerVertex * vertexAttribute-&gt;fSourceIndex + 2];</div>
<div class="line">                                size = 3 * <span class="keyword">sizeof</span>( <span class="keywordtype">float</span>);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">case</span> cgfxVertexAttribute::kColor:</div>
<div class="line">                            <span class="keywordflow">if</span>( colorCount &gt; vertexAttribute-&gt;fSourceIndex &amp;&amp; colorArrays[ vertexAttribute-&gt;fSourceIndex])</div>
<div class="line">                            {</div>
<div class="line">                                src = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)colorArrays[ vertexAttribute-&gt;fSourceIndex];</div>
<div class="line">                                size = 4 * <span class="keyword">sizeof</span>( <span class="keywordtype">float</span>);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">default</span>:</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// Do we have a valid input?</span></div>
<div class="line">                    <span class="keywordflow">if</span>( src &amp;&amp; size)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// Setup this element</span></div>
<div class="line">                        <span class="keywordtype">int</span> srcSkip = 0;</div>
<div class="line">                        <span class="keywordflow">if</span>( size &gt; fVertexStructure-&gt;fElements[ i].fSize)</div>
<div class="line">                        {</div>
<div class="line">                            srcSkip = size - fVertexStructure-&gt;fElements[ i].fSize;</div>
<div class="line">                            size = fVertexStructure-&gt;fElements[ i].fSize;</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordtype">int</span> dstSkip = fVertexStructure-&gt;fSize - size;</div>
<div class="line">                        <span class="keywordtype">char</span>* dst = dest;</div>
<div class="line">                        <span class="keywordflow">for</span>( <span class="keywordtype">int</span> v = 0; v &lt; vertexCount; v++)</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">for</span>( <span class="keywordtype">int</span> b = 0; b &lt; size; b++)</div>
<div class="line">                                *dst++ = *src++;</div>
<div class="line">                            src += srcSkip;</div>
<div class="line">                            dst += dstSkip;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// NULL this element</span></div>
<div class="line">                        size = fVertexStructure-&gt;fElements[ i].fSize;</div>
<div class="line">                        <span class="keywordtype">int</span> dstSkip = fVertexStructure-&gt;fSize - size;</div>
<div class="line">                        <span class="keywordtype">char</span>* dst = dest;</div>
<div class="line">                        <span class="keywordflow">for</span>( <span class="keywordtype">int</span> v = 0; v &lt; vertexCount; v++)</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">for</span>( <span class="keywordtype">int</span> b = 0; b &lt; size; b++)</div>
<div class="line">                                *dst++ = 0;</div>
<div class="line">                            dst += dstSkip;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                dest += fVertexStructure-&gt;fElements[ i].fSize;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        result = bind( (<span class="keyword">const</span> <span class="keywordtype">float</span>*)data, fVertexStructure-&gt;fSize / <span class="keyword">sizeof</span>( <span class="keywordtype">float</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If we were unable to bind a stream of data to this register, set a friendly NULL value</span></div>
<div class="line">    <span class="keywordflow">if</span>( !result)</div>
<div class="line">        null();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Bind data to GL</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> cgfxVaryingParameter::bind( <span class="keyword">const</span> <span class="keywordtype">float</span>* data, <span class="keywordtype">int</span> stride)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">switch</span>( fGLType)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kPosition:</div>
<div class="line">            glStateCache::instance().enablePosition();</div>
<div class="line">            glVertexPointer( stride, GL_FLOAT, 0, data);</div>
<div class="line">            result = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kNormal:</div>
<div class="line">            <span class="keywordflow">if</span>( stride == 3)</div>
<div class="line">            {</div>
<div class="line">                glStateCache::instance().enableNormal();</div>
<div class="line">                glNormalPointer( GL_FLOAT, 0, data);</div>
<div class="line">                result = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kTexCoord:</div>
<div class="line">            <span class="keywordflow">if</span>( fGLIndex &lt; glStateCache::sMaxTextureUnits)</div>
<div class="line">            {</div>
<div class="line">                glStateCache::instance().enableAndActivateTexCoord( fGLIndex);</div>
<div class="line">                glTexCoordPointer( stride, GL_FLOAT, 0, data);</div>
<div class="line">                result = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kColor:</div>
<div class="line">            <span class="keywordflow">if</span>( stride &gt; 2)</div>
<div class="line">            {</div>
<div class="line">                glStateCache::instance().enableColor();</div>
<div class="line">                glColorPointer( stride, GL_FLOAT, 0, data);</div>
<div class="line">                result = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kSecondaryColor:</div>
<div class="line">            <span class="keywordflow">if</span>( stride &gt; 2)</div>
<div class="line">            {</div>
<div class="line">                glStateCache::instance().enableSecondaryColor();</div>
<div class="line">                <span class="keywordflow">if</span>( glVertexAttribPointer) </div>
<div class="line">                    glSecondaryColorPointer( stride, GL_FLOAT, 0, (GLvoid*)data);</div>
<div class="line">                result = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kVertexAttrib:</div>
<div class="line">            glStateCache::instance().enableVertexAttrib( fGLIndex);</div>
<div class="line">            <span class="keywordflow">if</span>( glVertexAttribPointer) </div>
<div class="line">                glVertexAttribPointer( fGLIndex, stride, GL_FLOAT, GL_FALSE, 0, data);</div>
<div class="line">            result = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> cgfxVaryingParameter::bind(<span class="keyword">const</span> sourceStreamInfo&amp; source)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="comment">// should assert(dataBufferId &gt; 0) here</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stride = source.fStride;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset = source.fOffset;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dimension  = source.fDimension;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elementSize  = source.fElementSize;</div>
<div class="line">    <span class="keyword">const</span> GLuint bufferId = source.fDataBufferId;</div>
<div class="line"></div>
<div class="line">    glBindBufferARB(GL_ARRAY_BUFFER_ARB, bufferId);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #define GLOBJECT_BUFFER_OFFSET(i) ((char *)NULL + (i)) // For GLObject offsets</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span>( fGLType)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kPosition:</div>
<div class="line">            glStateCache::instance().enablePosition();</div>
<div class="line">            glVertexPointer(dimension, GL_FLOAT, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kNormal:</div>
<div class="line">            glStateCache::instance().enableNormal();</div>
<div class="line">            glNormalPointer(GL_FLOAT, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kTexCoord:</div>
<div class="line">            <span class="keywordflow">if</span>( fGLIndex &lt; glStateCache::sMaxTextureUnits)</div>
<div class="line">            {</div>
<div class="line">                glStateCache::instance().enableAndActivateTexCoord( fGLIndex);</div>
<div class="line">                glTexCoordPointer(dimension, GL_FLOAT, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kColor:</div>
<div class="line">            glStateCache::instance().enableColor();</div>
<div class="line">            glColorPointer(dimension, GL_FLOAT, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kSecondaryColor:</div>
<div class="line">            glStateCache::instance().enableSecondaryColor();</div>
<div class="line">            <span class="keywordflow">if</span>( glVertexAttribPointer) </div>
<div class="line">                glSecondaryColorPointer(dimension, GL_FLOAT, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kVertexAttrib:</div>
<div class="line">            glStateCache::instance().enableVertexAttrib( fGLIndex);</div>
<div class="line">            <span class="keywordflow">if</span>( glVertexAttribPointer) </div>
<div class="line">                glVertexAttribPointer( fGLIndex, dimension, GL_FLOAT, GL_FALSE, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(source.fSourceType == cgfxVertexAttribute::kPosition) {</div>
<div class="line">                glStateCache::instance().enablePosition();</div>
<div class="line">                glVertexPointer(dimension, GL_FLOAT, stride*elementSize, GLOBJECT_BUFFER_OFFSET(offset));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">//these we don&#39;t support yet</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Send null data to GL</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> cgfxVaryingParameter::null()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">switch</span>( fGLType)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kPosition:</div>
<div class="line">            <span class="comment">//null position is not expected, give a warning</span></div>
<div class="line">            <a name="a7"></a><a class="code" href="#!/url=./cpp_ref/class_m_global.html#acb043e7fc4eb7fc0f39833d31364b8a4">MGlobal::displayWarning</a>( <span class="stringliteral">&quot;There is no position data!&quot;</span> );</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kNormal:</div>
<div class="line">            glNormal3f( 0.0f, 0.0f, 1.0f);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kTexCoord:</div>
<div class="line">            glStateCache::instance().activeTexture( fGLIndex);</div>
<div class="line">            glMultiTexCoord4fARB( GL_TEXTURE0 + fGLIndex, 0.0f, 0.0f, 0.0f, 0.0f );</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kColor:</div>
<div class="line">            glColor4f( 1.0f, 1.0f, 1.0f, 1.0f);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kSecondaryColor:</div>
<div class="line">            <span class="keywordflow">if</span>( glSecondaryColor3f) </div>
<div class="line">                glSecondaryColor3f( 1.0f, 1.0f, 1.0f);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> glRegister::kVertexAttrib:</div>
<div class="line">            <span class="keywordflow">if</span>( glVertexAttrib4f) </div>
<div class="line">                glVertexAttrib4f( fGLIndex, 0.0f, 0.0f, 0.0f, 0.0f);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> cgfxVaryingParameter::addRecursive(</div>
<div class="line">    CGparameter parameter,</div>
<div class="line">    cgfxVaryingParameter**&amp; nextParameter</div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( cgGetParameterVariability( parameter) == CG_VARYING)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( cgGetParameterType( parameter) == CG_STRUCT)</div>
<div class="line">        {</div>
<div class="line">            CGparameter input = cgGetFirstStructParameter( parameter);</div>
<div class="line">            <span class="keywordflow">while</span>( input)</div>
<div class="line">            {</div>
<div class="line">                addRecursive( input, nextParameter);</div>
<div class="line">                input = cgGetNextParameter( input);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( cgIsParameterReferenced( parameter))</div>
<div class="line">        {</div>
<div class="line">            *nextParameter = <span class="keyword">new</span> cgfxVaryingParameter( parameter);</div>
<div class="line">            nextParameter = &amp;(*nextParameter)-&gt;fNext;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// A pass in a technique</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line">cgfxPass::cgfxPass(</div>
<div class="line">    CGpass                  pass,</div>
<div class="line">    <span class="keyword">const</span> cgfxProfile*      profile</div>
<div class="line">)</div>
<div class="line"> :  fPass( pass),</div>
<div class="line">    fProgram( NULL),</div>
<div class="line">    fParameters( NULL),</div>
<div class="line">    fDefaultProfile(<span class="stringliteral">&quot;default&quot;</span>, pass),</div>
<div class="line">    fNext( NULL)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( pass)</div>
<div class="line">    {</div>
<div class="line">        fName = cgGetPassName( pass);</div>
<div class="line">        CGstateassignment stateAssignment = cgGetFirstStateAssignment( pass);</div>
<div class="line">        cgfxVaryingParameter** nextParameter = &amp;fParameters;</div>
<div class="line">        <span class="keywordflow">while</span>( stateAssignment )</div>
<div class="line">        {</div>
<div class="line">            CGstate state = cgGetStateAssignmentState( stateAssignment);</div>
<div class="line">            <span class="keywordflow">if</span>( cgGetStateType( state) == CG_PROGRAM_TYPE &amp;&amp; </div>
<div class="line">                    ( stricmp( cgGetStateName( state), <span class="stringliteral">&quot;vertexProgram&quot;</span>) == 0 ||</div>
<div class="line">                      stricmp( cgGetStateName( state), <span class="stringliteral">&quot;vertexShader&quot;</span>) == 0))</div>
<div class="line">            {</div>
<div class="line">                fProgram = cgGetProgramStateAssignmentValue( stateAssignment);</div>
<div class="line">                <span class="keywordflow">if</span>( fProgram)</div>
<div class="line">                {</div>
<div class="line">                    CGparameter parameter = cgGetFirstParameter( fProgram, CG_PROGRAM);</div>
<div class="line">                    <span class="keywordflow">while</span>( parameter)</div>
<div class="line">                    {</div>
<div class="line">                        cgfxVaryingParameter::addRecursive( parameter, nextParameter);</div>
<div class="line">                        parameter = cgGetNextParameter( parameter);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            setProfile(profile);</div>
<div class="line">            stateAssignment = cgGetNextStateAssignment( stateAssignment);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">cgfxPass::~cgfxPass()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> fNext;</div>
<div class="line">    <span class="keyword">delete</span> fParameters;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxPass::setupAttributes(cgfxRCPtr&lt;cgfxVertexAttribute&gt;&amp; vertexAttributes)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    cgfxVaryingParameter* parameter = fParameters;</div>
<div class="line">    <span class="keywordflow">while</span>( parameter)</div>
<div class="line">    {</div>
<div class="line">        parameter-&gt;setupAttributes( vertexAttributes, fProgram);</div>
<div class="line">        parameter = parameter-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxPass::setProfile(<span class="keyword">const</span> cgfxProfile* profile)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="comment">// If profile is null, we use the default Cg profile, i.e. the</span></div>
<div class="line">    <span class="comment">// profile specified in the .cgfx file.</span></div>
<div class="line">    <span class="keywordflow">if</span> (profile == NULL) profile = &amp;fDefaultProfile;</div>
<div class="line"></div>
<div class="line">    CGprogram vp = cgGetPassProgram(fPass, CG_VERTEX_DOMAIN);</div>
<div class="line">    <span class="keywordflow">if</span> (vp != NULL &amp;&amp;</div>
<div class="line">        cgGetProgramProfile(vp) != profile-&gt;getVertexProfile())</div>
<div class="line">    {</div>
<div class="line">        cgSetProgramProfile(vp, profile-&gt;getVertexProfile());</div>
<div class="line">    }</div>
<div class="line">    CGprogram gp = cgGetPassProgram(fPass, CG_GEOMETRY_DOMAIN);</div>
<div class="line">    <span class="keywordflow">if</span> (gp != NULL &amp;&amp;</div>
<div class="line">        profile-&gt;getGeometryProfile() != CG_PROFILE_UNKNOWN &amp;&amp;</div>
<div class="line">        cgGetProgramProfile(gp) != profile-&gt;getGeometryProfile())</div>
<div class="line">    {</div>
<div class="line">        cgSetProgramProfile(gp, profile-&gt;getGeometryProfile());</div>
<div class="line">    }</div>
<div class="line">    CGprogram fp = cgGetPassProgram(fPass, CG_FRAGMENT_DOMAIN);</div>
<div class="line">    <span class="keywordflow">if</span> (fp != NULL &amp;&amp;</div>
<div class="line">        cgGetProgramProfile(fp) != profile-&gt;getFragmentProfile())</div>
<div class="line">    {</div>
<div class="line">        cgSetProgramProfile(fp, profile-&gt;getFragmentProfile());</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxPass::bind(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html">MDagPath</a>&amp; shape, cgfxStructureCache* cache,</div>
<div class="line">    <span class="keywordtype">int</span> vertexCount, <span class="keyword">const</span> <span class="keywordtype">float</span> * vertexArray,</div>
<div class="line">    <span class="keywordtype">int</span> normalsPerVertex, <span class="keywordtype">int</span> normalCount, <span class="keyword">const</span> <span class="keywordtype">float</span> ** normalArrays,</div>
<div class="line">    <span class="keywordtype">int</span> colorCount, <span class="keyword">const</span> <span class="keywordtype">float</span> ** colorArrays,</div>
<div class="line">    <span class="keywordtype">int</span> texCoordCount, <span class="keyword">const</span> <span class="keywordtype">float</span> ** texCoordArrays</div>
<div class="line">)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    cgfxVaryingParameter* parameter = fParameters;</div>
<div class="line">    <span class="keywordflow">while</span>( parameter)</div>
<div class="line">    {</div>
<div class="line">        parameter-&gt;bind(shape, cache, </div>
<div class="line">                        vertexCount, vertexArray, </div>
<div class="line">                        normalsPerVertex, normalCount, normalArrays, </div>
<div class="line">                        colorCount, colorArrays, </div>
<div class="line">                        texCoordCount, texCoordArrays);</div>
<div class="line">        parameter = parameter-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxPass::bind(<span class="keyword">const</span> sourceStreamInfo dataSources[], <span class="keyword">const</span> <span class="keywordtype">int</span> sourceCount)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    TRACE_API_CALLS(<span class="stringliteral">&quot;cgfxPass::bind&quot;</span>);</div>
<div class="line"></div>
<div class="line">    cgfxVaryingParameter* parameter = fParameters;</div>
<div class="line">    <span class="keywordflow">while</span>( parameter)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Here we only deal with fVertexAttribute.  How to do fVertexStructure?</span></div>
<div class="line">        <span class="keywordflow">if</span> (parameter-&gt;fVertexAttribute.isNull() == <span class="keyword">false</span>) {</div>
<div class="line">            <span class="comment">//find the corresponding data buffer</span></div>
<div class="line">            <span class="keywordtype">int</span> index = 0;</div>
<div class="line">            <span class="keywordflow">for</span>(index = 0; index &lt; sourceCount; ++index)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// printf(</span></div>
<div class="line">                <span class="comment">// &quot;    Compare param %s (0x%p) [%s] name (type=%d) with data source name [%s] (type=%d)\n&quot;, </span></div>
<div class="line">                <span class="comment">//         parameter-&gt;fName.asChar(),</span></div>
<div class="line">                <span class="comment">//         parameter,</span></div>
<div class="line">                <span class="comment">//         parameter-&gt;fVertexAttribute-&gt;fSourceName.asChar(), </span></div>
<div class="line">                <span class="comment">//         parameter-&gt;fVertexAttribute-&gt;fSourceType,</span></div>
<div class="line">                <span class="comment">//         dataSources[index].fSourceName.asChar(),</span></div>
<div class="line">                <span class="comment">//         dataSources[index].fSourceType);</span></div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (dataSources[index].fSourceName == parameter-&gt;fVertexAttribute-&gt;fSourceName )</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// we find the correct vertex stream</span></div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }   </div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(index &lt; sourceCount)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// printf(&quot;    Binding source name [%s]\n&quot;, dataSources[index].fSourceName.asChar());</span></div>
<div class="line">                <span class="keywordflow">if</span>(!parameter-&gt;bind(dataSources[index])) {</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// This is a true error. Binding should normally</span></div>
<div class="line">                    <span class="comment">// always succeed here as the geometry</span></div>
<div class="line">                    <span class="comment">// requirements are verified in</span></div>
<div class="line">                    <span class="comment">// cgfxShaderOverride::initialize().</span></div>
<div class="line">                    parameter-&gt;null();</div>
<div class="line"></div>
<div class="line">                    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> s = <span class="stringliteral">&quot;cgfxShader : Couldn&#39;t bind source \&quot;&quot;</span>;</div>
<div class="line">                    s += dataSources[index].fSourceName;</div>
<div class="line">                    s += <span class="stringliteral">&quot;\&quot; for vertex attribute \&quot;&quot;</span>;</div>
<div class="line">                    s += parameter-&gt;fVertexAttribute-&gt;fSourceName;;</div>
<div class="line">                    s +=<span class="stringliteral">&quot;\&quot;.&quot;</span>;</div>
<div class="line">                    <a name="a8"></a><a class="code" href="#!/url=./cpp_ref/class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(s);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// printf(&quot;    Can&#39;t find the source for source name [%s] for parameter [%s]\n&quot;, </span></div>
<div class="line">                <span class="comment">//        parameter-&gt;fVertexAttribute-&gt;fSourceName.asChar(),</span></div>
<div class="line">                <span class="comment">//        parameter-&gt;fVertexAttribute-&gt;fName.asChar());</span></div>
<div class="line"></div>
<div class="line">                <span class="comment">// There is no matching source for this parameter. We</span></div>
<div class="line">                <span class="comment">// therefore bind null data for this parameter. Note</span></div>
<div class="line">                <span class="comment">// that this fact should have already been reported</span></div>
<div class="line">                <span class="comment">// to the user in cgfxShaderOverride::initialize(). We</span></div>
<div class="line">                <span class="comment">// don&#39;t report it to the user here because it would</span></div>
<div class="line">                <span class="comment">// get repetitively reported for each redraw.</span></div>
<div class="line">                parameter-&gt;null();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        parameter = parameter-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// printf(&quot;    Successfully bound sources\n&quot;);</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// A technique in an effect</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line">cgfxTechnique::cgfxTechnique(</div>
<div class="line">    CGtechnique         technique,</div>
<div class="line">    <span class="keyword">const</span> cgfxProfile*  profile</div>
<div class="line">)</div>
<div class="line">:   fTechnique( technique),</div>
<div class="line">    fValid(false),</div>
<div class="line">    fPasses(NULL),</div>
<div class="line">    fNumPasses(0),</div>
<div class="line">    fNext(NULL)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (technique)</div>
<div class="line">    {</div>
<div class="line">        fName = cgGetTechniqueName(technique);</div>
<div class="line">        CGpass pass = cgGetFirstPass(technique);</div>
<div class="line">        cgfxPass** nextPass = &amp;fPasses;</div>
<div class="line">        <span class="keywordflow">while</span> (pass)</div>
<div class="line">        {</div>
<div class="line">            ++fNumPasses;</div>
<div class="line">            *nextPass = <span class="keyword">new</span> cgfxPass(pass, profile);</div>
<div class="line">            nextPass = &amp;(*nextPass)-&gt;fNext;</div>
<div class="line">            pass = cgGetNextPass(pass);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        fHasBlending = hasBlending(fTechnique);</div>
<div class="line"></div>
<div class="line">        setProfile(profile);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxTechnique::~cgfxTechnique()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> fNext;</div>
<div class="line">    <span class="keyword">delete</span> fPasses;</div>
<div class="line">    fNext = 0;</div>
<div class="line">    fPasses = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxTechnique::setProfile(<span class="keyword">const</span> cgfxProfile* profile)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keyword">const</span> cgfxProfile* supportedProfile = getSupportedProfile(profile);</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> cgfxPass* pass = fPasses;</div>
<div class="line">    <span class="keywordflow">while</span> (pass) {</div>
<div class="line">        pass-&gt;setProfile(supportedProfile);</div>
<div class="line">        pass = pass-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Changing the profile might change the validity of the technique.</span></div>
<div class="line">    validate();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxTechnique::validate()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    fValid = (cgValidateTechnique(fTechnique) == CG_TRUE);</div>
<div class="line">    <span class="keywordflow">if</span> (fValid) {</div>
<div class="line">        fErrorString = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        CGerror error = cgGetError();</div>
<div class="line">        <span class="keywordflow">if</span> (error != CG_NO_ERROR) {</div>
<div class="line">            fErrorString = cgGetErrorString(cgGetError());</div>
<div class="line">        }</div>
<div class="line">        fErrorString += <span class="stringliteral">&quot;\nCg compilation errors for technique \&quot;&quot;</span>;</div>
<div class="line">        fErrorString += fName;</div>
<div class="line">        fErrorString += <span class="stringliteral">&quot;\&quot;:\n&quot;</span>;</div>
<div class="line">        fErrorString += cgGetLastListing(cgfxShaderNode::sCgContext);</div>
<div class="line">        fErrorString += <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> cgfxProfile* cgfxTechnique::getSupportedProfile(<span class="keyword">const</span> cgfxProfile* profile)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">if</span> (profile == NULL) {</div>
<div class="line">        <span class="comment">// The user wants to use the default profile. Let&#39;s see if</span></div>
<div class="line">        <span class="comment">// this is supported on the current platform.</span></div>
<div class="line">        <span class="keywordtype">bool</span> allPassProfilesSupported = <span class="keyword">true</span>;</div>
<div class="line">        <span class="keyword">const</span> cgfxPass* pass = fPasses;</div>
<div class="line">        <span class="keywordflow">while</span> (pass) {</div>
<div class="line">            <span class="keywordflow">if</span> (!pass-&gt;fDefaultProfile.isSupported()) {</div>
<div class="line">                allPassProfilesSupported = <span class="keyword">false</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            pass = pass-&gt;fNext;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (allPassProfilesSupported) {</div>
<div class="line">            <span class="comment">// Ok. We can use the default profile!</span></div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> es;</div>
<div class="line">            es += <span class="stringliteral">&quot;The technique \&quot;&quot;</span>;</div>
<div class="line">            es += fName;</div>
<div class="line">            es += <span class="stringliteral">&quot;\&quot; specifies Cg profiles that are unsupported on this platform. &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;The profile \&quot;&quot;</span>;</div>
<div class="line">            es += cgfxProfile::getBestProfile()-&gt;getName();</div>
<div class="line">            es += <span class="stringliteral">&quot;\&quot; will be used instead.&quot;</span>;</div>
<div class="line">            <a class="code" href="#!/url=./cpp_ref/class_m_global.html#acb043e7fc4eb7fc0f39833d31364b8a4">MGlobal::displayWarning</a>(es);</div>
<div class="line">        </div>
<div class="line">            <span class="keywordflow">return</span> cgfxProfile::getBestProfile();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> profile;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxRCPtr&lt;cgfxVertexAttribute&gt; cgfxTechnique::getVertexAttributes()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    cgfxRCPtr&lt;cgfxVertexAttribute&gt; vertexAttributes;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> cgfxPass* pass = fPasses;</div>
<div class="line">    <span class="keywordflow">while</span> (pass) {</div>
<div class="line">        pass-&gt;setupAttributes(vertexAttributes);</div>
<div class="line">        pass = pass-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> vertexAttributes;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Scan the technique for passes which use blending</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> cgfxTechnique::hasBlending(CGtechnique technique)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Assume not blending</span></div>
<div class="line">    <span class="keywordtype">bool</span> hasBlending = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check for : BlendEnable=true, BlendFunc=something valid on the first pass only.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// We ignore any depth enable and functions for now...</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    CGpass cgPass = cgGetFirstPass(technique);</div>
<div class="line">    <span class="keywordtype">bool</span> foundBlendEnabled = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> foundBlendFunc = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (cgPass)</div>
<div class="line">    {</div>
<div class="line">        CGstateassignment stateAssignment = cgGetFirstStateAssignment(cgPass);</div>
<div class="line">        <span class="keywordflow">while</span> ( stateAssignment )</div>
<div class="line">        {</div>
<div class="line">            CGstate state = cgGetStateAssignmentState( stateAssignment);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *stateName = cgGetStateName(state);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Check for blend enabled.</span></div>
<div class="line">            <span class="keywordflow">if</span> (!foundBlendEnabled &amp;&amp; stricmp( stateName, <span class="stringliteral">&quot;BlendEnable&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> numValues = 0;</div>
<div class="line">                <span class="keyword">const</span> CGbool *values = cgGetBoolStateAssignmentValues(stateAssignment, &amp;numValues);</div>
<div class="line">                <span class="keywordflow">if</span> (values &amp;&amp; numValues)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (values[0])</div>
<div class="line">                    {</div>
<div class="line">                        foundBlendEnabled = <span class="keyword">true</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Check for valid blend function</span></div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!foundBlendFunc &amp;&amp; ( stricmp( stateName, <span class="stringliteral">&quot;BlendFunc&quot;</span>) == 0 ||</div>
<div class="line">                                          stricmp( stateName, <span class="stringliteral">&quot;BlendFuncSeparate&quot;</span>) == 0 ))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> numValues = 0;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> * values = cgGetIntStateAssignmentValues(stateAssignment, &amp;numValues);</div>
<div class="line">                <span class="keywordflow">if</span> (values)</div>
<div class="line">                {</div>
<div class="line"><span class="preprocessor">#ifdef MAYA_PRINT_DEBUG_INFO</span></div>
<div class="line">                    <span class="comment">/*</span></div>
<div class="line"><span class="comment">                    #define GL_SRC_COLOR                      0x0300 = 768</span></div>
<div class="line"><span class="comment">                    #define GL_ONE_MINUS_SRC_COLOR            0x0301 = 769</span></div>
<div class="line"><span class="comment">                    #define GL_SRC_ALPHA                      0x0302 = 770</span></div>
<div class="line"><span class="comment">                    #define GL_ONE_MINUS_SRC_ALPHA            0x0303 = 771</span></div>
<div class="line"><span class="comment">                    #define GL_DST_ALPHA                      0x0304 = 772</span></div>
<div class="line"><span class="comment">                    #define GL_ONE_MINUS_DST_ALPHA            0x0305 = 773</span></div>
<div class="line"><span class="comment">                    */</span></div>
<div class="line">                    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> blendStringTable[6] =</div>
<div class="line">                    {</div>
<div class="line">                        <span class="stringliteral">&quot;GL_SRC_COLOR&quot;</span>, <span class="comment">// SrcColor</span></div>
<div class="line">                        <span class="stringliteral">&quot;GL_ONE_MINUS_SRC_COLOR&quot;</span>, <span class="comment">// OneMinusSrcColor</span></div>
<div class="line">                        <span class="stringliteral">&quot;GL_SRC_ALPHA&quot;</span>, <span class="comment">// SrcAlpha</span></div>
<div class="line">                        <span class="stringliteral">&quot;GL_ONE_MINUS_SRC_ALPHA&quot;</span>, <span class="comment">// OneMinusSrcAlpha</span></div>
<div class="line">                        <span class="stringliteral">&quot;GL_DST_ALPHA&quot;</span>, <span class="comment">// DstAlpha</span></div>
<div class="line">                        <span class="stringliteral">&quot;GL_ONE_MINUS_DST_ALPHA&quot;</span> <span class="comment">// OneMinusDstAlpha</span></div>
<div class="line">                    };</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numValues; i++)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span> ((values[i] &gt;= GL_SRC_COLOR) &amp;&amp; (values[i] &lt;= GL_ONE_MINUS_DST_ALPHA))</div>
<div class="line">                        {</div>
<div class="line"><span class="preprocessor">#ifdef MAYA_PRINT_DEBUG_INFO</span></div>
<div class="line">                            printf(<span class="stringliteral">&quot;Found blend function = %s, %s\n&quot;</span>,</div>
<div class="line">                            blendStringTable[ values[0]-GL_SRC_COLOR].asChar(),</div>
<div class="line">                            blendStringTable[ values[1]-GL_SRC_COLOR].asChar());</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">                            foundBlendFunc = <span class="keyword">true</span>;</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            hasBlending = foundBlendEnabled &amp;&amp; foundBlendFunc;</div>
<div class="line">            <span class="keywordflow">if</span> (hasBlending)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            stateAssignment = cgGetNextStateAssignment( stateAssignment);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> hasBlending;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>cgfxEffectInternal</div>
<div class="line">{</div>
<div class="line">    time_t fileTimeStamp(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">struct </span>stat statBuf;</div>
<div class="line">        <span class="keywordflow">if</span>( stat(fileName.<a class="code" href="#!/url=./cpp_ref/class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), &amp;statBuf) != 0 )</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> statBuf.st_mtime;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>EffectKey</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> cgfxProfile* profile;</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> fileName;</div>
<div class="line">        time_t timeStamp;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> operator&lt; (<span class="keyword">const</span> EffectKey&amp; lhs, <span class="keyword">const</span> EffectKey&amp; rhs)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> (lhs.profile &lt;  rhs.profile) ||</div>
<div class="line">               (lhs.profile == rhs.profile &amp;&amp; ( (lhs.timeStamp &lt;  rhs.timeStamp) ||</div>
<div class="line">                                                (lhs.timeStamp == rhs.timeStamp &amp;&amp; strcmp(lhs.fileName.asChar(), rhs.fileName.asChar()) &lt; 0) ) );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Collection of effects</span></div>
<div class="line">    <span class="comment">// The collection does not use smart pointer (cgfxRCPtr) to store the effects</span></div>
<div class="line">    <span class="comment">// Otherwise they will never get released (refCount always &gt;= 1)</span></div>
<div class="line">    <span class="comment">// Effect will have to be manually removed from collection by desctructor (~cgfxEffect())</span></div>
<div class="line">    <span class="keyword">class </span>cgfxEffectCollection</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        cgfxEffect* find(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName, <span class="keyword">const</span> cgfxProfile* profile) <span class="keyword">const</span>;</div>
<div class="line">        <span class="keywordtype">void</span> add(cgfxEffect* effect, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName, <span class="keyword">const</span> cgfxProfile* profile);</div>
<div class="line">        <span class="keywordtype">void</span> <span class="keyword">remove</span>(cgfxEffect* effect);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        <span class="keyword">typedef</span> std::map&lt; cgfxEffect*, EffectKey &gt; Effect2KeyMap;</div>
<div class="line">        Effect2KeyMap effect2KeyMap;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">typedef</span> std::map&lt; EffectKey, cgfxEffect* &gt; Key2EffectMap;</div>
<div class="line">        Key2EffectMap key2EffectMap;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    cgfxEffect* cgfxEffectCollection::find(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName, <span class="keyword">const</span> cgfxProfile* profile)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        cgfxEffect* effect = NULL;</div>
<div class="line"></div>
<div class="line">        EffectKey key = { profile, fileName, fileTimeStamp(fileName) } ;</div>
<div class="line"></div>
<div class="line">        Key2EffectMap::const_iterator it = key2EffectMap.find(key);</div>
<div class="line">        <span class="keywordflow">if</span>(it != key2EffectMap.end())</div>
<div class="line">        {</div>
<div class="line">            effect = it-&gt;second;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> effect;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> cgfxEffectCollection::add(cgfxEffect* effect, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName, <span class="keyword">const</span> cgfxProfile* profile)</div>
<div class="line">    {</div>
<div class="line">        EffectKey key = { profile, fileName, fileTimeStamp(fileName) } ;</div>
<div class="line"></div>
<div class="line">        key2EffectMap.insert( std::make_pair(key, effect) );</div>
<div class="line">        effect2KeyMap.insert( std::make_pair(effect, key) );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> cgfxEffectCollection::remove(cgfxEffect* effect)</div>
<div class="line">    {</div>
<div class="line">        Effect2KeyMap::iterator it = effect2KeyMap.find(effect);</div>
<div class="line">        <span class="keywordflow">if</span>(it != effect2KeyMap.end())</div>
<div class="line">        {</div>
<div class="line">            key2EffectMap.erase( it-&gt;second );</div>
<div class="line">            effect2KeyMap.erase( it );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> cgfxEffectCollection gEffectsCollection;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxRCPtr&lt;const cgfxEffect&gt; cgfxEffect::loadEffect(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName, <span class="keyword">const</span> cgfxProfile* profile)</div>
<div class="line">{</div>
<div class="line">    cgfxEffect *effect = cgfxEffectInternal::gEffectsCollection.find(fileName, profile);</div>
<div class="line">    <span class="keywordflow">if</span>(effect == NULL)</div>
<div class="line">    {</div>
<div class="line">        effect = <span class="keyword">new</span> cgfxEffect(fileName, profile);</div>
<div class="line">        cgfxEffectInternal::gEffectsCollection.add(effect, fileName, profile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cgfxRCPtr&lt;const cgfxEffect&gt;(effect);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// An effect</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">cgfxEffect::cgfxEffect(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; fileName, <span class="keyword">const</span> cgfxProfile* profile)</div>
<div class="line">  : refcount(0),</div>
<div class="line">    fEffect(NULL),</div>
<div class="line">    fTechniques(NULL),</div>
<div class="line">    fProfile(NULL)</div>
<div class="line">{</div>
<div class="line">    <a name="_a9"></a><a class="code" href="#!/url=./cpp_ref/class_m_string_array.html">MStringArray</a> fileOptions;</div>
<div class="line">    cgfxGetFxIncludePath( fileName, fileOptions );</div>
<div class="line">    fileOptions.<a name="a10"></a><a class="code" href="#!/url=./cpp_ref/class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>(<span class="stringliteral">&quot;-DMAYA_CGFX=1&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (cgfxProfile::getTexCoordOrientation() == cgfxProfile::TEXCOORD_OPENGL) {</div>
<div class="line">        fileOptions.<a class="code" href="#!/url=./cpp_ref/class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>(<span class="stringliteral">&quot;-DMAYA_TEXCOORD_ORIENTATION_OPENGL=1&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        fileOptions.<a class="code" href="#!/url=./cpp_ref/class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>(<span class="stringliteral">&quot;-DMAYA_TEXCOORD_ORIENTATION_DIRECTX=1&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *opts[_CGFX_PLUGIN_MAX_COMPILER_ARGS_];</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numOpts = fileOptions.<a name="a11"></a><a class="code" href="#!/url=./cpp_ref/class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (numOpts)</div>
<div class="line">    {</div>
<div class="line">        numOpts = (numOpts &gt; _CGFX_PLUGIN_MAX_COMPILER_ARGS_-1) ?</div>
<div class="line">            _CGFX_PLUGIN_MAX_COMPILER_ARGS_-1 : numOpts;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;numOpts; i++)</div>
<div class="line">            opts[i] = fileOptions[i].asChar();</div>
<div class="line">        opts[numOpts] = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fEffect = cgCreateEffectFromFile(cgfxShaderNode::sCgContext, fileName.<a class="code" href="#!/url=./cpp_ref/class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), opts);</div>
<div class="line">    <span class="keywordflow">if</span> (fEffect)</div>
<div class="line">    {</div>
<div class="line">        CGtechnique technique = cgGetFirstTechnique(fEffect);</div>
<div class="line">        cgfxTechnique** nextTechnique = <span class="keyword">const_cast&lt;</span>cgfxTechnique**<span class="keyword">&gt;</span>(&amp;fTechniques);</div>
<div class="line">        <span class="keywordflow">while</span> (technique)</div>
<div class="line">        {</div>
<div class="line">            *nextTechnique = <span class="keyword">new</span> cgfxTechnique(technique, profile);</div>
<div class="line">            nextTechnique = &amp;(*nextTechnique)-&gt;fNext;</div>
<div class="line">            technique = cgGetNextTechnique(technique);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        fProfile = profile;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">cgfxEffect::~cgfxEffect()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Remove this effect from the collection</span></div>
<div class="line">    cgfxEffectInternal::gEffectsCollection.remove(<span class="keyword">this</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">delete</span> fTechniques;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fEffect) {</div>
<div class="line">        cgDestroyEffect(fEffect);</div>
<div class="line">        fEffect = NULL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    fTechniques = NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxEffect::release()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    --refcount;</div>
<div class="line">    <span class="keywordflow">if</span> (refcount &lt;= 0)</div>
<div class="line">    {</div>
<div class="line">        M_CHECK( refcount == 0 );</div>
<div class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line">    </div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> cgfxTechnique* cgfxEffect::getTechnique(<a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> techniqueName)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keyword">const</span> cgfxTechnique* technique = fTechniques;</div>
<div class="line">    <span class="keywordflow">while</span>(technique)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(technique-&gt;fName == techniqueName)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        technique = technique-&gt;fNext;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> technique;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxEffect::setProfile(<span class="keyword">const</span> cgfxProfile* profile)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">if</span> (fProfile != profile) {</div>
<div class="line">        fProfile = profile;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> cgfxTechnique* technique = fTechniques;</div>
<div class="line">        <span class="keywordflow">while</span>(technique)</div>
<div class="line">        {</div>
<div class="line">            technique-&gt;setProfile(profile);</div>
<div class="line">            technique = technique-&gt;fNext;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ========== cgfxEffect::attrsFromEffect ==========</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// This function parses through an effect and builds a list of</span></div>
<div class="line"><span class="comment">// cgfxAttrDef objects.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">cgfxRCPtr&lt;cgfxAttrDefList&gt; cgfxEffect::attrsFromEffect()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">if</span> (!fEffect)</div>
<div class="line">        <span class="keywordflow">return</span> cgfxRCPtr&lt;cgfxAttrDefList&gt;();</div>
<div class="line"></div>
<div class="line">    cgfxRCPtr&lt;cgfxAttrDefList&gt; list(<span class="keyword">new</span> cgfxAttrDefList);</div>
<div class="line"></div>
<div class="line">    CGparameter cgParameter = cgGetFirstEffectParameter(fEffect);</div>
<div class="line">    <span class="keywordtype">int</span> i = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (cgParameter)</div>
<div class="line">    {</div>
<div class="line">        cgfxAttrDef* aDef = <span class="keyword">new</span> cgfxAttrDef(cgParameter);</div>
<div class="line">        list-&gt;add(aDef);</div>
<div class="line"></div>
<div class="line">        cgParameter = cgGetNextParameter(cgParameter);</div>
<div class="line">        ++i;</div>
<div class="line">    } <span class="comment">// end of for each parameter</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> list;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxStructureCache::cgfxStructureCache()</div>
<div class="line">    : fEntries(NULL)</div>
<div class="line">{}</div>
<div class="line"></div>
<div class="line">cgfxStructureCache::~cgfxStructureCache()</div>
<div class="line">{</div>
<div class="line">    flush();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxStructureCache::Entry::Entry(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html">MDagPath</a>&amp; shape, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; name, <span class="keywordtype">int</span> stride, <span class="keywordtype">int</span> count</div>
<div class="line">)</div>
<div class="line">  : fShape(shape.node()),</div>
<div class="line">    fName(name),</div>
<div class="line">    fData(new char[ stride * count])</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cgfxStructureCache::Entry::~Entry()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span>[] fData;</div>
<div class="line">    fNext = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span>* cgfxStructureCache::findEntry(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html">MDagPath</a>&amp; shape, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; name)</div>
<div class="line">{</div>
<div class="line">    Entry** entry = &amp;fEntries;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (*entry)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( !(*entry)-&gt;fShape.isValid() || !(*entry)-&gt;fShape.isAlive())</div>
<div class="line">        {</div>
<div class="line">            Entry* staleEntry = *entry;</div>
<div class="line">            *entry = staleEntry-&gt;fNext;</div>
<div class="line">            <span class="keyword">delete</span> staleEntry;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> </div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>( (*entry)-&gt;fShape == shape.<a name="a12"></a><a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html#ae024049dad815f2f186e6a4fead8be51">node</a>() &amp;&amp; (*entry)-&gt;fName == name)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> (*entry)-&gt;fData;</div>
<div class="line">            }</div>
<div class="line">            entry = &amp;(*entry)-&gt;fNext;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span>* cgfxStructureCache::addEntry(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html">MDagPath</a>&amp; shape,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp;  name,</div>
<div class="line">    <span class="keywordtype">int</span>             stride,</div>
<div class="line">    <span class="keywordtype">int</span>             count</div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">    Entry* cacheEntry = <span class="keyword">new</span> Entry(shape, name, stride, count);</div>
<div class="line"></div>
<div class="line">    cacheEntry-&gt;fNext = fEntries;</div>
<div class="line">    fEntries = cacheEntry;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cacheEntry-&gt;fData;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxStructureCache::flush()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> fEntries;</div>
<div class="line">    fEntries = NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> cgfxStructureCache::flush(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html">MDagPath</a>&amp; shape)</div>
<div class="line">{</div>
<div class="line">    Entry** cacheEntry = &amp;fEntries;</div>
<div class="line">    <span class="keywordflow">while</span>( *cacheEntry)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( !(*cacheEntry)-&gt;fShape.isValid() || !(*cacheEntry)-&gt;fShape.isAlive() ||</div>
<div class="line">            (*cacheEntry)-&gt;fShape == shape.<a class="code" href="#!/url=./cpp_ref/class_m_dag_path.html#ae024049dad815f2f186e6a4fead8be51">node</a>())</div>
<div class="line">        {</div>
<div class="line">            Entry* staleEntry = (*cacheEntry);</div>
<div class="line">            *cacheEntry = staleEntry-&gt;fNext;</div>
<div class="line">            staleEntry-&gt;fNext = NULL;</div>
<div class="line">            <span class="keyword">delete</span> staleEntry;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            cacheEntry = &amp;(*cacheEntry)-&gt;fNext;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->

      <div class="footer-block"><a href="../html/ac.cmtdialog.htm" class="comments-anchor" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
   </div></body>
</html>
